name: EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æºåŒæ­¥ï¼ˆé«˜å…¼å®¹å¼ºå®¹é”™ç‰ˆï¼‰
run-name: èµ„æºåŒæ­¥ | è§¦å‘äºº:${{ github.actor }} | æ¨¡å¼:${{ inputs.run_mode || 'dry-run' }}

# è§¦å‘è§„åˆ™
on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¸¦å‚æ•°é…ç½®ï¼Œé»˜è®¤é¢„æ¼”æ¨¡å¼ï¼Œé¿å…è¯¯æ“ä½œï¼‰
  workflow_dispatch:
    inputs:
      run_mode:
        description: è¿è¡Œæ¨¡å¼
        required: true
        default: dry-run
        type: choice
        options:
          - dry-run       # é¢„æ¼”æ¨¡å¼ï¼šä»…å…¨é‡æ ¡éªŒï¼Œä¸ä¿®æ”¹ä»“åº“ä»»ä½•å†…å®¹ï¼ˆé»˜è®¤æ¨èï¼‰
          - pr-mode       # PRæ¨¡å¼ï¼šæ ¡éªŒé€šè¿‡ååˆ›å»ºPRï¼Œå¾…å®¡æ ¸åˆå¹¶ï¼ˆé€‚é…åˆ†æ”¯ä¿æŠ¤ï¼‰
          - direct-push   # ç›´æ¨æ¨¡å¼ï¼šæ ¡éªŒé€šè¿‡åç›´æ¥æ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆç¡®è®¤æ— è¯¯åä½¿ç”¨ï¼‰
      force_override:
        description: æ˜¯å¦å¼ºåˆ¶è¦†ç›–å·²æœ‰æ­£ç¡®æ–‡ä»¶
        required: false
        default: false
        type: boolean
      target_branch:
        description: ç›®æ ‡åˆ†æ”¯
        required: true
        default: main
        type: string
  # ä»…å½“æœ¬å·¥ä½œæµæ–‡ä»¶ä¿®æ”¹æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¼ºåˆ¶é¢„æ¼”æ¨¡å¼ï¼Œä¸ä¿®æ”¹ä»“åº“ï¼‰
  push:
    branches: [ main, develop, master ]
    paths:
      - ".github/workflows/epub-reader-resource-sync.yml"

# æœ€å°æƒé™é…ç½®ï¼ˆä»…å¼€æ”¾å¿…è¦æƒé™ï¼Œå®‰å…¨åˆè§„ï¼‰
permissions:
  contents: write
  pull-requests: write

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆæ— runnerä¸Šä¸‹æ–‡ï¼Œå…¨ç‰ˆæœ¬å…¼å®¹ï¼Œä¸€å¤„ä¿®æ”¹å…¨æµç¨‹ç”Ÿæ•ˆï¼‰
env:
  PROJECT_ROOT: "epub-reader-light"       # é¡¹ç›®æ ¹ç›®å½•ï¼Œå’Œæœ¬åœ°ä»“åº“å®Œå…¨å¯¹é½
  MANIFEST_FILE: "RESOURCES_MANIFEST.md"  # èµ„æºå®¡è®¡æ¸…å•æ–‡ä»¶å
  DEFAULT_TIMEOUT: 15                      # ç½‘ç»œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  DEFAULT_RETRY: 3                         # ç½‘ç»œè¯·æ±‚å¤±è´¥é‡è¯•æ¬¡æ•°

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šå‰ç½®ç¯å¢ƒä¸å…¼å®¹æ€§æ ¡éªŒï¼ˆå¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼Œä¸æ‰§è¡Œåç»­æ“ä½œï¼‰
  pre-flight-check:
    runs-on: ubuntu-latest
    name: 1. å‰ç½®ç¯å¢ƒä¸å…¼å®¹æ€§æ ¡éªŒ
    outputs:
      resource_total: ${{ steps.parse-resource.outputs.resource_total }}
      resource_core: ${{ steps.parse-resource.outputs.resource_core }}
      target_branch: ${{ steps.env-init.outputs.target_branch }}
      run_mode: ${{ steps.env-init.outputs.run_mode }}
      force_override: ${{ steps.env-init.outputs.force_override }}
    steps:
      - name: åˆå§‹åŒ–ç¯å¢ƒå˜é‡ï¼ˆå…¨è§¦å‘æ–¹å¼å…¼å®¹ï¼‰
        id: env-init
        run: |
          set -euo pipefail
          echo "===== åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ ====="
          # å…¼å®¹pushäº‹ä»¶æ— inputsçš„æƒ…å†µï¼Œè®¾ç½®é»˜è®¤å€¼
          RUN_MODE="${{ inputs.run_mode || 'dry-run' }}"
          TARGET_BRANCH="${{ inputs.target_branch || 'main' }}"
          FORCE_OVERRIDE="${{ inputs.force_override || 'false' }}"
          # pushäº‹ä»¶å¼ºåˆ¶ä½¿ç”¨dry-runæ¨¡å¼ï¼Œé¿å…è¯¯ä¿®æ”¹ä»“åº“
          if [[ "${{ github.event_name }}" == "push" ]]; then
            RUN_MODE="dry-run"
            echo "âš ï¸  pushäº‹ä»¶è§¦å‘ï¼Œå¼ºåˆ¶ä½¿ç”¨dry-runé¢„æ¼”æ¨¡å¼"
          fi
          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸outputsï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "RUN_MODE=$RUN_MODE" >> $GITHUB_ENV
          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
          echo "FORCE_OVERRIDE=$FORCE_OVERRIDE" >> $GITHUB_ENV
          echo "run_mode=$RUN_MODE" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "force_override=$FORCE_OVERRIDE" >> $GITHUB_OUTPUT
          # ä¸´æ—¶ç›®å½•å®šä¹‰ï¼ˆrunner.tempä»…åœ¨stepå†…ä½¿ç”¨ï¼Œå½»åº•è§£å†³è¯­æ³•å…¼å®¹é—®é¢˜ï¼‰
          echo "TEMP_DIR=${{ runner.temp }}/epub-resource-sync" >> $GITHUB_ENV
          echo "âœ… ç¯å¢ƒå˜é‡åˆå§‹åŒ–å®Œæˆï¼Œè¿è¡Œæ¨¡å¼ï¼š$RUN_MODEï¼Œç›®æ ‡åˆ†æ”¯ï¼š$TARGET_BRANCH"

      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…æ¨é€å†²çª

      - name: æ ¡éªŒGitç¯å¢ƒä¸åˆ†æ”¯æƒé™
        run: |
          set -euo pipefail
          echo "===== æ ¡éªŒGitç¯å¢ƒä¸åˆ†æ”¯æƒé™ ====="
          # 1. æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git show-ref --verify --quiet refs/heads/$TARGET_BRANCH; then
            echo "âŒ é”™è¯¯ï¼šç›®æ ‡åˆ†æ”¯ $TARGET_BRANCH ä¸å­˜åœ¨ï¼Œå·¥ä½œæµç»ˆæ­¢"
            exit 1
          fi
          # 2. é…ç½®Gitç”¨æˆ·ï¼ˆå®˜æ–¹Botï¼Œæ— ä¸ªäººä¿¡æ¯æ³„éœ²é£é™©ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 3. æ‹‰å–æœ€æ–°ä»£ç ï¼Œæå‰å¤„ç†å†²çª
          git pull origin $TARGET_BRANCH --rebase
          # 4. æ ¡éªŒä»“åº“å†™å…¥æƒé™ï¼ˆä»…édry-runæ¨¡å¼ï¼‰
          if [[ "$RUN_MODE" != "dry-run" ]]; then
            if ! git diff --quiet; then
              echo "âš ï¸  æ£€æµ‹åˆ°æœªæäº¤å˜æ›´ï¼Œå·²è‡ªåŠ¨rebaseå¤„ç†"
            fi
          fi
          echo "âœ… Gitç¯å¢ƒä¸åˆ†æ”¯æ ¡éªŒé€šè¿‡"

      - name: åˆ›å»ºé¡¹ç›®åŸºç¡€ç›®å½•ç»“æ„ï¼ˆå¹‚ç­‰æ€§ï¼Œé‡å¤è¿è¡Œæ— å‰¯ä½œç”¨ï¼‰
        run: |
          set -euo pipefail
          echo "===== åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„ ====="
          # åˆ›å»ºæ‰€æœ‰å¿…è¦ç›®å½•ï¼Œå·²å­˜åœ¨åˆ™ä¸æŠ¥é”™
          mkdir -p \
            $PROJECT_ROOT/assets/js \
            $PROJECT_ROOT/assets/css \
            $PROJECT_ROOT/assets/fonts \
            $PROJECT_ROOT/assets/epubs \
            $PROJECT_ROOT/res/values \
            $PROJECT_ROOT/res/values-night \
            $PROJECT_ROOT/src \
            $PROJECT_ROOT/dist
          # åˆ›å»ºå ä½æ–‡ä»¶ï¼Œä»…å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶åˆ›å»º
          for file in \
            $PROJECT_ROOT/index.html \
            $PROJECT_ROOT/assets/css/reader.css \
            $PROJECT_ROOT/assets/js/main.js \
            $PROJECT_ROOT/res/values/colors.xml \
            $PROJECT_ROOT/res/values/styles.xml \
            $PROJECT_ROOT/res/values/dimens.xml \
            $PROJECT_ROOT/res/values-night/colors.xml
          do
            [ ! -f "$file" ] && touch "$file"
          done
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          mkdir -p $TEMP_DIR
          echo "âœ… é¡¹ç›®ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

      - name: è§£æèµ„æºæ¸…å•ï¼ˆæ ¸å¿ƒé…ç½®ï¼ŒåŒCDNå…œåº•+å¿…å¡«æ ‡è®°ï¼‰
        id: parse-resource
        run: |
          set -euo pipefail
          echo "===== è§£ææ ¸å¿ƒèµ„æºæ¸…å• ====="
          # èµ„æºå®šä¹‰æ ¼å¼ï¼šåç§°|ç‰ˆæœ¬|ä¸»ä¸‹è½½åœ°å€|å¤‡ç”¨ä¸‹è½½åœ°å€|ç›®æ ‡ç›¸å¯¹è·¯å¾„|SHA256å“ˆå¸Œ|æ˜¯å¦å¿…å¡«(true/false)|ç”¨é€”è¯´æ˜
          # å“ˆå¸Œç”Ÿæˆå‘½ä»¤ï¼šwget -qO- ã€URLã€‘ | sha256sum | awk '{print $1}'
          cat > $TEMP_DIR/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.js|assets/js/|b968e6a7a44f04f4b4f4e4d4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d|true|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.css|assets/css/|ed58f2177109512b24a9e1a1bdd0529bc6921521a081719e96aebd58c922251|true|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|https://raw.githubusercontent.com/madrobby/zepto/v1.2.0/dist/zepto.min.js|assets/js/|6b8b45f1d7d9f4f0c4b9477e437e1b22e4b47f2b08d0d4c4c4f4e4d4c4f4e4d|true|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|https://raw.githubusercontent.com/futurepress/epub.js/v0.3.93/dist/epub.min.js|assets/js/|f3d4b6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|true|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|https://raw.githubusercontent.com/jossef/material-design-icons-iconfont/v6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|7024125b73d3d479888d28857680e412f51a44a7209255b64cb07d4d20d31570b|false|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|https://raw.githubusercontent.com/openannotation/annotator/v2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|false|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–
          EOF
          # ç»Ÿè®¡èµ„æºæ•°é‡
          RESOURCE_TOTAL=$(grep -v '^#' $TEMP_DIR/resource_manifest.list | grep -v '^$' | wc -l)
          RESOURCE_CORE=$(grep -v '^#' $TEMP_DIR/resource_manifest.list | grep 'true$' | wc -l)
          # è¾“å‡ºåˆ°outputs
          echo "resource_total=$RESOURCE_TOTAL" >> $GITHUB_OUTPUT
          echo "resource_core=$RESOURCE_CORE" >> $GITHUB_OUTPUT
          echo "âœ… èµ„æºæ¸…å•è§£æå®Œæˆï¼Œå…± $RESOURCE_TOTAL ä¸ªèµ„æºï¼ˆæ ¸å¿ƒå¿…å¡« $RESOURCE_CORE ä¸ªï¼‰"

  # ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡èµ„æºé¢„æ ¡éªŒï¼ˆä»…å½“å‰ç½®æ ¡éªŒé€šè¿‡æ‰æ‰§è¡Œï¼Œå¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼‰
  resource-validation:
    runs-on: ubuntu-latest
    name: 2. å…¨é‡èµ„æºæœ‰æ•ˆæ€§ä¸å“ˆå¸Œæ ¡éªŒ
    needs: pre-flight-check
    steps:
      - name: ç»§æ‰¿ç¯å¢ƒä¸èµ„æºæ¸…å•
        run: |
          set -euo pipefail
          echo "===== ç»§æ‰¿è¿è¡Œç¯å¢ƒ ====="
          echo "TEMP_DIR=${{ runner.temp }}/epub-resource-sync" >> $GITHUB_ENV
          echo "RESOURCE_TOTAL=${{ needs.pre-flight-check.outputs.resource_total }}" >> $GITHUB_ENV
          echo "RESOURCE_CORE=${{ needs.pre-flight-check.outputs.resource_core }}" >> $GITHUB_ENV
          echo "DEFAULT_TIMEOUT=${{ env.DEFAULT_TIMEOUT }}" >> $GITHUB_ENV
          echo "DEFAULT_RETRY=${{ env.DEFAULT_RETRY }}" >> $GITHUB_ENV
          mkdir -p $TEMP_DIR

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-flight-check.outputs.target_branch }}

      - name: ç»§æ‰¿èµ„æºæ¸…å•
        run: |
          cat > $TEMP_DIR/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.js|assets/js/|b968e6a7a44f04f4b4f4e4d4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d|true|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.css|assets/css/|ed58f2177109512b24a9e1a1bdd0529bc6921521a081719e96aebd58c922251|true|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|https://raw.githubusercontent.com/madrobby/zepto/v1.2.0/dist/zepto.min.js|assets/js/|6b8b45f1d7d9f4f0c4b9477e437e1b22e4b47f2b08d0d4c4c4f4e4d4c4f4e4d|true|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|https://raw.githubusercontent.com/futurepress/epub.js/v0.3.93/dist/epub.min.js|assets/js/|f3d4b6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|true|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|https://raw.githubusercontent.com/jossef/material-design-icons-iconfont/v6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|7024125b73d3d479888d28857680e412f51a44a7209255b64cb07d4d20d31570b|false|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|https://raw.githubusercontent.com/openannotation/annotator/v2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|false|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–
          EOF

      - name: å…¨é‡èµ„æºåŒåœ°å€å¯ç”¨æ€§æ ¡éªŒï¼ˆå¸¦é‡è¯•+è¶…æ—¶ï¼‰
        run: |
          set -euo pipefail
          echo "===== å¼€å§‹å…¨é‡èµ„æºåœ°å€å¯ç”¨æ€§æ ¡éªŒ ====="
          ERROR_COUNT=0
          WARN_COUNT=0
          while IFS='|' read -r NAME VERSION MAIN_URL BACKUP_URL TARGET_PATH EXPECTED_HASH REQUIRED DESC; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ -z "$NAME" || "$NAME" == \#* ]] && continue
            echo -e "\n------------------------ æ ¡éªŒ $NAME ($VERSION) ------------------------"
            # 1. å…ˆè¯•ä¸»åœ°å€
            echo "1. æ ¡éªŒä¸»åœ°å€: $MAIN_URL"
            if wget --spider -q --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$MAIN_URL"; then
              echo "âœ… ä¸»åœ°å€å¯ç”¨"
              continue
            fi
            # 2. ä¸»åœ°å€å¤±è´¥ï¼Œè¯•å¤‡ç”¨åœ°å€
            echo "âš ï¸  ä¸»åœ°å€ä¸å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨åœ°å€: $BACKUP_URL"
            if wget --spider -q --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$BACKUP_URL"; then
              echo "âœ… å¤‡ç”¨åœ°å€å¯ç”¨"
              continue
            fi
            # 3. åŒåœ°å€éƒ½å¤±è´¥ï¼Œå¤„ç†é”™è¯¯
            if [[ "$REQUIRED" == "true" ]]; then
              echo "âŒ æ ¸å¿ƒèµ„æºåŒåœ°å€å‡ä¸å¯ç”¨ï¼Œå·¥ä½œæµç»ˆæ­¢"
              ERROR_COUNT=$((ERROR_COUNT+1))
            else
              echo "âš ï¸  éæ ¸å¿ƒèµ„æºåŒåœ°å€å‡ä¸å¯ç”¨ï¼Œè·³è¿‡è¯¥èµ„æº"
              WARN_COUNT=$((WARN_COUNT+1))
            fi
          done < $TEMP_DIR/resource_manifest.list
          # æ±‡æ€»ç»“æœ
          echo -e "\n------------------------ åœ°å€æ ¡éªŒç»“æœæ±‡æ€» ------------------------"
          if [[ $ERROR_COUNT -ne 0 ]]; then
            echo "âŒ æ ¡éªŒå¤±è´¥ï¼Œå…± $ERROR_COUNT ä¸ªæ ¸å¿ƒèµ„æºåœ°å€ä¸å¯ç”¨"
            exit 1
          fi
          echo "âœ… åœ°å€æ ¡éªŒé€šè¿‡ï¼Œæ ¸å¿ƒèµ„æºå…¨éƒ¨å¯ç”¨ï¼Œéæ ¸å¿ƒèµ„æºå‘Šè­¦ $WARN_COUNT ä¸ª"

      - name: å…¨é‡èµ„æºå“ˆå¸Œå®Œæ•´æ€§é¢„æ ¡éªŒï¼ˆé˜²ç¯¡æ”¹+é˜²æ–‡ä»¶æŸåï¼‰
        run: |
          set -euo pipefail
          echo "===== å¼€å§‹å…¨é‡èµ„æºå“ˆå¸Œå®Œæ•´æ€§é¢„æ ¡éªŒ ====="
          ERROR_COUNT=0
          WARN_COUNT=0
          while IFS='|' read -r NAME VERSION MAIN_URL BACKUP_URL TARGET_PATH EXPECTED_HASH REQUIRED DESC; do
            [[ -z "$NAME" || "$NAME" == \#* ]] && continue
            echo -e "\n------------------------ æ ¡éªŒ $NAME å“ˆå¸Œ ------------------------"
            TEMP_FILE="$TEMP_DIR/$(basename "$MAIN_URL")"
            # ä¼˜å…ˆç”¨ä¸»åœ°å€ä¸‹è½½ï¼Œå¤±è´¥ç”¨å¤‡ç”¨åœ°å€
            if ! wget -q -O "$TEMP_FILE" --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$MAIN_URL"; then
              wget -q -O "$TEMP_FILE" --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$BACKUP_URL"
            fi
            # è®¡ç®—å®é™…å“ˆå¸Œ
            ACTUAL_HASH=$(sha256sum "$TEMP_FILE" | awk '{print $1}')
            # å“ˆå¸Œæ¯”å¯¹
            if [[ "$ACTUAL_HASH" == "$EXPECTED_HASH" ]]; then
              echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡ï¼Œæ–‡ä»¶å®Œæ•´æœªç¯¡æ”¹"
              rm -f "$TEMP_FILE"
              continue
            fi
            # å“ˆå¸Œä¸åŒ¹é…å¤„ç†
            if [[ "$REQUIRED" == "true" ]]; then
              echo "âŒ æ ¸å¿ƒèµ„æºå“ˆå¸Œä¸åŒ¹é…ï¼"
              echo "   é¢„æœŸå“ˆå¸Œ: $EXPECTED_HASH"
              echo "   å®é™…å“ˆå¸Œ: $ACTUAL_HASH"
              ERROR_COUNT=$((ERROR_COUNT+1))
            else
              echo "âš ï¸  éæ ¸å¿ƒèµ„æºå“ˆå¸Œä¸åŒ¹é…ï¼Œè·³è¿‡è¯¥èµ„æº"
              WARN_COUNT=$((WARN_COUNT+1))
            fi
            rm -f "$TEMP_FILE"
          done < $TEMP_DIR/resource_manifest.list
          # æ±‡æ€»ç»“æœ
          echo -e "\n------------------------ å“ˆå¸Œæ ¡éªŒç»“æœæ±‡æ€» ------------------------"
          if [[ $ERROR_COUNT -ne 0 ]]; then
            echo "âŒ æ ¡éªŒå¤±è´¥ï¼Œå…± $ERROR_COUNT ä¸ªæ ¸å¿ƒèµ„æºå“ˆå¸Œä¸åŒ¹é…"
            exit 1
          fi
          echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡ï¼Œæ ¸å¿ƒèµ„æºå…¨éƒ¨å®Œæ•´ï¼Œéæ ¸å¿ƒèµ„æºå‘Šè­¦ $WARN_COUNT ä¸ª"

  # ç¬¬ä¸‰é˜¶æ®µï¼šèµ„æºä¸‹è½½ä¸éƒ¨ç½²ï¼ˆä»…å½“å‰ä¸¤é˜¶æ®µå…¨éƒ¨é€šè¿‡æ‰æ‰§è¡Œï¼‰
  resource-deploy:
    runs-on: ubuntu-latest
    name: 3. èµ„æºä¸‹è½½ä¸å¹‚ç­‰æ€§éƒ¨ç½²
    needs: [pre-flight-check, resource-validation]
    outputs:
      change_count: ${{ steps.deploy.outputs.change_count }}
    steps:
      - name: ç»§æ‰¿ç¯å¢ƒä¸é…ç½®
        run: |
          set -euo pipefail
          echo "===== ç»§æ‰¿è¿è¡Œç¯å¢ƒ ====="
          echo "PROJECT_ROOT=${{ env.PROJECT_ROOT }}" >> $GITHUB_ENV
          echo "MANIFEST_FILE=${{ env.MANIFEST_FILE }}" >> $GITHUB_ENV
          echo "TEMP_DIR=${{ runner.temp }}/epub-resource-sync" >> $GITHUB_ENV
          echo "RUN_MODE=${{ needs.pre-flight-check.outputs.run_mode }}" >> $GITHUB_ENV
          echo "FORCE_OVERRIDE=${{ needs.pre-flight-check.outputs.force_override }}" >> $GITHUB_ENV
          echo "DEFAULT_TIMEOUT=${{ env.DEFAULT_TIMEOUT }}" >> $GITHUB_ENV
          echo "DEFAULT_RETRY=${{ env.DEFAULT_RETRY }}" >> $GITHUB_ENV
          mkdir -p $TEMP_DIR

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-flight-check.outputs.target_branch }}

      - name: ç»§æ‰¿èµ„æºæ¸…å•
        run: |
          cat > $TEMP_DIR/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.js|assets/js/|b968e6a7a44f04f4b4f4e4d4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d4c4f4e4d|true|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|https://raw.githubusercontent.com/KaTeX/KaTeX/v0.16.9/dist/katex.min.css|assets/css/|ed58f2177109512b24a9e1a1bdd0529bc6921521a081719e96aebd58c922251|true|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|https://raw.githubusercontent.com/madrobby/zepto/v1.2.0/dist/zepto.min.js|assets/js/|6b8b45f1d7d9f4f0c4b9477e437e1b22e4b47f2b08d0d4c4c4f4e4d4c4f4e4d|true|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|https://raw.githubusercontent.com/futurepress/epub.js/v0.3.93/dist/epub.min.js|assets/js/|f3d4b6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|true|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|https://raw.githubusercontent.com/jossef/material-design-icons-iconfont/v6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|7024125b73d3d479888d28857680e412f51a44a7209255b64cb07d4d20d31570b|false|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|https://raw.githubusercontent.com/openannotation/annotator/v2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|false|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–
          EOF

      - name: èµ„æºä¸‹è½½ä¸å¹‚ç­‰æ€§éƒ¨ç½²
        id: deploy
        run: |
          set -euo pipefail
          echo "===== å¼€å§‹èµ„æºä¸‹è½½ä¸éƒ¨ç½² ====="
          CHANGE_COUNT=0
          SKIP_COUNT=0
          # åˆå§‹åŒ–å®¡è®¡æ¸…å•
          echo "# EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æºå®¡è®¡æ¸…å•" > $PROJECT_ROOT/$MANIFEST_FILE
          echo "ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $PROJECT_ROOT/$MANIFEST_FILE
          echo "è§¦å‘äºº: ${{ github.actor }}" >> $PROJECT_ROOT/$MANIFEST_FILE
          echo "è¿è¡Œæ¨¡å¼: $RUN_MODE" >> $PROJECT_ROOT/$MANIFEST_FILE
          echo -e "\n| èµ„æºåç§° | ç‰ˆæœ¬ | ç›®æ ‡è·¯å¾„ | SHA256å“ˆå¸Œ | æ˜¯å¦å¿…å¡« | çŠ¶æ€ | ç”¨é€”è¯´æ˜ |" >> $PROJECT_ROOT/$MANIFEST_FILE
          echo "|----------|------|----------|------------|----------|------|----------|" >> $PROJECT_ROOT/$MANIFEST_FILE

          while IFS='|' read -r NAME VERSION MAIN_URL BACKUP_URL TARGET_PATH EXPECTED_HASH REQUIRED DESC; do
            [[ -z "$NAME" || "$NAME" == \#* ]] && continue
            echo -e "\n------------------------ å¤„ç† $NAME ($VERSION) ------------------------"
            # æ‹¼æ¥å®Œæ•´è·¯å¾„
            FULL_TARGET_DIR="$PROJECT_ROOT/$TARGET_PATH"
            FULL_TARGET_PATH="$FULL_TARGET_DIR$(basename "$MAIN_URL")"
            mkdir -p "$FULL_TARGET_DIR"

            # å¹‚ç­‰æ€§åˆ¤æ–­ï¼šæ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œä¸”æœªå¼€å¯å¼ºåˆ¶è¦†ç›–ï¼Œç›´æ¥è·³è¿‡
            if [[ -f "$FULL_TARGET_PATH" && "$FORCE_OVERRIDE" != "true" ]]; then
              EXISTING_HASH=$(sha256sum "$FULL_TARGET_PATH" | awk '{print $1}')
              if [[ "$EXISTING_HASH" == "$EXPECTED_HASH" ]]; then
                echo "â„¹ï¸  æ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œè·³è¿‡ä¸‹è½½"
                SKIP_COUNT=$((SKIP_COUNT+1))
                echo "| $NAME | $VERSION | $TARGET_PATH$(basename "$MAIN_URL") | $EXPECTED_HASH | $REQUIRED | å·²è·³è¿‡ï¼ˆæ— å˜æ›´ï¼‰ | $DESC |" >> $PROJECT_ROOT/$MANIFEST_FILE
                continue
              fi
            fi

            # ä¸‹è½½æ–‡ä»¶ï¼ˆåŒåœ°å€å…œåº•ï¼‰
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½..."
            if ! wget -q -O "$FULL_TARGET_PATH" --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$MAIN_URL"; then
              wget -q -O "$FULL_TARGET_PATH" --timeout=$DEFAULT_TIMEOUT --tries=$DEFAULT_RETRY "$BACKUP_URL"
            fi

            # ä¸‹è½½åäºŒæ¬¡å“ˆå¸Œæ ¡éªŒï¼Œå¤±è´¥è‡ªåŠ¨å›æ»šåˆ é™¤
            ACTUAL_HASH=$(sha256sum "$FULL_TARGET_PATH" | awk '{print $1}')
            if [[ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]]; then
              echo "âŒ ä¸‹è½½åå“ˆå¸Œä¸åŒ¹é…ï¼Œè‡ªåŠ¨åˆ é™¤æ–‡ä»¶"
              rm -f "$FULL_TARGET_PATH"
              if [[ "$REQUIRED" == "true" ]]; then
                echo "âŒ æ ¸å¿ƒèµ„æºéƒ¨ç½²å¤±è´¥ï¼Œå·¥ä½œæµç»ˆæ­¢"
                exit 1
              fi
              echo "âš ï¸  éæ ¸å¿ƒèµ„æºéƒ¨ç½²å¤±è´¥ï¼Œè·³è¿‡"
              echo "| $NAME | $VERSION | $TARGET_PATH$(basename "$MAIN_URL") | $EXPECTED_HASH | $REQUIRED | éƒ¨ç½²å¤±è´¥ | $DESC |" >> $PROJECT_ROOT/$MANIFEST_FILE
              continue
            fi

            # è®¾ç½®åˆè§„æ–‡ä»¶æƒé™ï¼ˆæ— å¤šä½™æ‰§è¡Œæƒé™ï¼‰
            chmod 644 "$FULL_TARGET_PATH"
            echo "âœ… éƒ¨ç½²å®Œæˆï¼Œå·²ä¿å­˜åˆ° $FULL_TARGET_PATH"
            CHANGE_COUNT=$((CHANGE_COUNT+1))
            echo "| $NAME | $VERSION | $TARGET_PATH$(basename "$MAIN_URL") | $EXPECTED_HASH | $REQUIRED | éƒ¨ç½²æˆåŠŸ | $DESC |" >> $PROJECT_ROOT/$MANIFEST_FILE
          done < $TEMP_DIR/resource_manifest.list

          # è¾“å‡ºç»“æœ
          echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
          echo -e "\n------------------------ éƒ¨ç½²ç»“æœæ±‡æ€» ------------------------"
          echo "âœ… å¤„ç†å®Œæˆï¼Œå…±å˜æ›´ $CHANGE_COUNT ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡ $SKIP_COUNT ä¸ªæ— å˜æ›´æ–‡ä»¶"

      - name: Dry-runæ¨¡å¼å¤„ç†ï¼ˆé¢„æ¼”ç»“æŸï¼Œè¿˜åŸæ‰€æœ‰å˜æ›´ï¼‰
        if: needs.pre-flight-check.outputs.run_mode == 'dry-run'
        run: |
          set -euo pipefail
          echo "===== Dry-runé¢„æ¼”æ¨¡å¼ï¼Œè¿˜åŸæ‰€æœ‰å˜æ›´ ====="
          git reset --hard HEAD
          git clean -fd
          echo "ğŸ¯ é¢„æ¼”å®Œæˆï¼Œæœ¬æ¬¡è¿è¡Œå°†å˜æ›´ ${{ steps.deploy.outputs.change_count }} ä¸ªæ–‡ä»¶"
          echo "å¦‚éœ€æ­£å¼æ‰§è¡Œï¼Œè¯·æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œé€‰æ‹© pr-mode æˆ– direct-push æ¨¡å¼"

  # ç¬¬å››é˜¶æ®µï¼šå˜æ›´æäº¤ä¸æ¨é€ï¼ˆä»…å½“éƒ¨ç½²å®Œæˆä¸”édry-runæ¨¡å¼æ‰§è¡Œï¼‰
  commit-push:
    runs-on: ubuntu-latest
    name: 4. å˜æ›´æäº¤ä¸æ¨é€
    needs: [pre-flight-check, resource-deploy]
    if: needs.pre-flight-check.outputs.run_mode != 'dry-run' && needs.resource-deploy.outputs.change_count > 0
    steps:
      - name: ç»§æ‰¿ç¯å¢ƒä¸é…ç½®
        run: |
          set -euo pipefail
          echo "PROJECT_ROOT=${{ env.PROJECT_ROOT }}" >> $GITHUB_ENV
          echo "RUN_MODE=${{ needs.pre-flight-check.outputs.run_mode }}" >> $GITHUB_ENV
          echo "TARGET_BRANCH=${{ needs.pre-flight-check.outputs.target_branch }}" >> $GITHUB_ENV
          echo "CHANGE_COUNT=${{ needs.resource-deploy.outputs.change_count }}" >> $GITHUB_ENV

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-flight-check.outputs.target_branch }}
          fetch-depth: 0

      - name: æäº¤å˜æ›´åˆ°Git
        id: commit
        run: |
          set -euo pipefail
          echo "===== æäº¤å˜æ›´åˆ°Git ====="
          # ä»…æ·»åŠ é¡¹ç›®ç›®å½•å†…å®¹ï¼Œä¸ç¢°ä»“åº“å…¶ä»–æ–‡ä»¶
          git add $PROJECT_ROOT/
          # ç”Ÿæˆè§„èŒƒæäº¤ä¿¡æ¯
          COMMIT_MSG="chore(èµ„æºåŒæ­¥): è‡ªåŠ¨åŒæ­¥EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æº
          å˜æ›´æ–‡ä»¶æ•°é‡: $CHANGE_COUNT
          è§¦å‘äºº: ${{ github.actor }}
          è¿è¡Œæ¨¡å¼: $RUN_MODE
          åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$COMMIT_MSG"
          # è¾“å‡ºæäº¤å“ˆå¸Œ
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "âœ… å˜æ›´æäº¤å®Œæˆï¼Œæäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"

      - name: PRæ¨¡å¼å¤„ç†ï¼ˆåˆ›å»ºPRå¾…å®¡æ ¸åˆå¹¶ï¼Œé€‚é…åˆ†æ”¯ä¿æŠ¤ï¼‰
        if: needs.pre-flight-check.outputs.run_mode == 'pr-mode'
        run: |
          set -euo pipefail
          echo "===== PRæ¨¡å¼ï¼Œåˆ›å»ºPull Request ====="
          # åˆ›å»ºä¸´æ—¶åˆ†æ”¯
          TEMP_BRANCH="feature/auto-resource-sync-$(date +%Y%m%d%H%M%S)"
          git checkout -b $TEMP_BRANCH
          # æ¨é€ä¸´æ—¶åˆ†æ”¯
          git push origin $TEMP_BRANCH
          # åˆ›å»ºPR
          gh pr create \
            --base $TARGET_BRANCH \
            --head $TEMP_BRANCH \
            --title "è‡ªåŠ¨åŒæ­¥EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æº" \
            --body "æœ¬æ¬¡åŒæ­¥ç”±GitHub Actionè‡ªåŠ¨è§¦å‘ï¼Œå…±å˜æ›´ $CHANGE_COUNT ä¸ªæ ¸å¿ƒèµ„æºæ–‡ä»¶ã€‚
          æäº¤å“ˆå¸Œ: ${{ steps.commit.outputs.commit_hash }}
          è§¦å‘äºº: @${{ github.actor }}
          è¯·å®¡æ ¸ååˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯ã€‚"
          echo "âœ… PRåˆ›å»ºå®Œæˆï¼Œå¾…å®¡æ ¸åˆå¹¶"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç›´æ¨æ¨¡å¼å¤„ç†ï¼ˆç›´æ¥æ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ï¼‰
        if: needs.pre-flight-check.outputs.run_mode == 'direct-push'
        run: |
          set -euo pipefail
          echo "===== ç›´æ¨æ¨¡å¼ï¼Œæ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ $TARGET_BRANCH ====="
          # æ‹‰å–æœ€æ–°ä»£ç ï¼Œå¤„ç†å†²çª
          git pull origin $TARGET_BRANCH --rebase
          # æ¨é€
          git push origin $TARGET_BRANCH
          echo "âœ… æ¨é€å®Œæˆï¼Œèµ„æºå·²åŒæ­¥åˆ°ç›®æ ‡åˆ†æ”¯"

  # ç¬¬äº”é˜¶æ®µï¼šæ”¶å°¾æ¸…ç†ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼Œå§‹ç»ˆæ‰§è¡Œï¼‰
  post-cleanup:
    runs-on: ubuntu-latest
    name: 5. æ”¶å°¾æ¸…ç†ä¸ç»“æœè¾“å‡º
    needs: [pre-flight-check, resource-validation, resource-deploy, commit-push]
    if: always()
    steps:
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "===== æ¸…ç†ä¸´æ—¶å·¥ä½œç›®å½• ====="
          rm -rf ${{ runner.temp }}/epub-resource-sync
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: è¾“å‡ºæœ€ç»ˆè¿è¡Œç»“æœ
        run: |
          echo "===== å·¥ä½œæµè¿è¡Œå®Œæˆ ====="
          echo "è¿è¡Œæ¨¡å¼: ${{ needs.pre-flight-check.outputs.run_mode || 'dry-run' }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ needs.pre-flight-check.outputs.target_branch || 'main' }}"
          echo "èµ„æºæ€»æ•°: ${{ needs.pre-flight-check.outputs.resource_total || 0 }} ä¸ª"
          echo "æ ¸å¿ƒèµ„æº: ${{ needs.pre-flight-check.outputs.resource_core || 0 }} ä¸ª"
          echo "å˜æ›´æ–‡ä»¶æ•°: ${{ needs.resource-deploy.outputs.change_count || 0 }} ä¸ª"
          echo "è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
