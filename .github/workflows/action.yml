name: EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æºåŒæ­¥ï¼ˆé«˜ç¼œå¯†ç‰ˆï¼‰
run-name: èµ„æºåŒæ­¥è§¦å‘äººï¼š${{ github.actor }}ï¼Œæ¨¡å¼ï¼š${{ inputs.run_mode }}

# è§¦å‘è§„åˆ™
on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¸¦å¯é…ç½®å‚æ•°ï¼Œæ ¸å¿ƒæ¨èæ–¹å¼ï¼‰
  workflow_dispatch:
    inputs:
      run_mode:
        description: è¿è¡Œæ¨¡å¼
        required: true
        default: dry-run
        type: choice
        options:
          - dry-run # é¢„æ¼”æ¨¡å¼ï¼šä»…éªŒè¯ï¼Œä¸ä¿®æ”¹ä»“åº“
          - pr-mode # PRæ¨¡å¼ï¼šéªŒè¯ä¸‹è½½åï¼Œåˆ›å»ºPRå¾…å®¡æ ¸åˆå¹¶
          - direct-push # ç›´æ¨æ¨¡å¼ï¼šéªŒè¯é€šè¿‡åç›´æ¥æ¨é€åˆ°ä¸»åˆ†æ”¯
      force_override:
        description: æ˜¯å¦å¼ºåˆ¶è¦†ç›–å·²æœ‰æ–‡ä»¶ï¼ˆä»…å½“èµ„æºå“ˆå¸Œå˜æ›´æ—¶ç”Ÿæ•ˆï¼‰
        required: false
        default: false
        type: boolean
      target_branch:
        description: ç›®æ ‡åˆ†æ”¯
        required: true
        default: main
        type: string

  # ä»…å½“æœ¬å·¥ä½œæµæ–‡ä»¶ä¿®æ”¹æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆé¢„æ¼”æ¨¡å¼ï¼Œä¸ä¿®æ”¹ä»“åº“ï¼‰
  push:
    branches: [ main, develop ]
    paths:
      - ".github/workflows/epub-reader-resource-sync.yml"

# æœ€å°æƒé™é…ç½®ï¼šä»…å¼€æ”¾ä»“åº“å†…å®¹å†™å…¥æƒé™ï¼Œå…¶ä»–æƒé™å…¨éƒ¨å…³é—­
permissions:
  contents: write
  pull-requests: write

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€é…ç½®ï¼Œä¸€å¤„ä¿®æ”¹å…¨æµç¨‹ç”Ÿæ•ˆï¼‰
env:
  # é¡¹ç›®æ ¹ç›®å½•ï¼ˆå’Œä½ æœ¬åœ°ä»“åº“ç»“æ„å®Œå…¨å¯¹é½ï¼‰
  PROJECT_ROOT: "epub-reader-light"
  # ä¸´æ—¶å·¥ä½œç›®å½•ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼Œä¸æ±¡æŸ“ä»“åº“ï¼‰
  TEMP_DIR: "${{ runner.temp }}/epub-resource-sync"
  # èµ„æºæ¸…å•æ–‡ä»¶ï¼ˆæ°¸ä¹…è®°å½•æ‰€æœ‰èµ„æºä¿¡æ¯ï¼Œå¯è¿½æº¯ï¼‰
  MANIFEST_FILE: "RESOURCES_MANIFEST.md"

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šå‰ç½®æ ¡éªŒä¸ç¯å¢ƒå‡†å¤‡ï¼ˆå¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼Œä¸æ‰§è¡Œåç»­æ“ä½œï¼‰
  pre-flight-check:
    runs-on: ubuntu-latest
    name: å‰ç½®æ ¡éªŒä¸ç¯å¢ƒå‡†å¤‡
    outputs:
      resource_count: ${{ steps.parse-manifest.outputs.resource_count }}
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref_name }}
          fetch-depth: 0

      - name: åˆå§‹åŒ–ç¯å¢ƒä¸ç›®å½•
        run: |
          echo "ğŸš€ åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ"
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p ${{ env.TEMP_DIR }}
          # åˆ›å»ºé¡¹ç›®åŸºç¡€ç›®å½•ç»“æ„ï¼ˆæå‰åˆ›å»ºï¼Œé¿å…åç»­ä¸‹è½½è·¯å¾„ä¸å­˜åœ¨ï¼‰
          mkdir -p \
            ${{ env.PROJECT_ROOT }}/assets/js \
            ${{ env.PROJECT_ROOT }}/assets/css \
            ${{ env.PROJECT_ROOT }}/assets/fonts \
            ${{ env.PROJECT_ROOT }}/assets/epubs \
            ${{ env.PROJECT_ROOT }}/res/values \
            ${{ env.PROJECT_ROOT }}/res/values-night \
            ${{ env.PROJECT_ROOT }}/src \
            ${{ env.PROJECT_ROOT }}/dist
          # åˆ›å»ºå ä½æ–‡ä»¶ï¼ˆä»…å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼‰
          for file in \
            ${{ env.PROJECT_ROOT }}/index.html \
            ${{ env.PROJECT_ROOT }}/assets/css/reader.css \
            ${{ env.PROJECT_ROOT }}/assets/js/main.js \
            ${{ env.PROJECT_ROOT }}/res/values/colors.xml \
            ${{ env.PROJECT_ROOT }}/res/values/styles.xml \
            ${{ env.PROJECT_ROOT }}/res/values/dimens.xml \
            ${{ env.PROJECT_ROOT }}/res/values-night/colors.xml
          do
            [ ! -f "$file" ] && touch "$file"
          done
          echo "âœ… ç›®å½•ç»“æ„åˆå§‹åŒ–å®Œæˆ"

      - name: ç”Ÿæˆå¹¶è§£æèµ„æºæ¸…å•ï¼ˆæ ¸å¿ƒé…ç½®ï¼Œæ‰€æœ‰èµ„æºåœ¨æ­¤å®šä¹‰ï¼‰
        id: parse-manifest
        run: |
          echo "ğŸ“‹ è§£ææ ¸å¿ƒèµ„æºæ¸…å•"
          # èµ„æºå®šä¹‰æ ¼å¼ï¼šåç§°|ç‰ˆæœ¬|ä¸‹è½½URL|ç›®æ ‡ç›¸å¯¹è·¯å¾„|SHA256å“ˆå¸Œ|ç”¨é€”è¯´æ˜
          # å“ˆå¸Œç”Ÿæˆå‘½ä»¤ï¼šwget -qO- ã€URLã€‘ | sha256sum | awk '{print $1}'
          cat > ${{ env.TEMP_DIR }}/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|assets/js/|2f3a4c8e9b0d7f1a2c3e4d5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|assets/css/|7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|assets/js/|3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|assets/js/|4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡ï¼Œé€‚é…æ‰€æœ‰å±å¹•
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–æ ¸å¿ƒ
          EOF
          # ç»Ÿè®¡æœ‰æ•ˆèµ„æºæ•°é‡
          RESOURCE_COUNT=$(grep -v '^#' ${{ env.TEMP_DIR }}/resource_manifest.list | grep -v '^$' | wc -l)
          echo "resource_count=$RESOURCE_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… èµ„æºæ¸…å•è§£æå®Œæˆï¼Œå…± $RESOURCE_COUNT ä¸ªæ ¸å¿ƒèµ„æº"

      - name: æ ¡éªŒGitç¯å¢ƒä¸åˆ†æ”¯æƒé™
        run: |
          echo "ğŸ” æ ¡éªŒGitç¯å¢ƒä¸åˆ†æ”¯æƒé™"
          # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git show-ref --verify --quiet refs/heads/${{ inputs.target_branch || github.ref_name }}; then
            echo "âŒ ç›®æ ‡åˆ†æ”¯ ${{ inputs.target_branch || github.ref_name }} ä¸å­˜åœ¨ï¼Œå·¥ä½œæµç»ˆæ­¢"
            exit 1
          fi
          # é…ç½®Gitç”¨æˆ·ï¼ˆActionå†…ç½®å®˜æ–¹Botï¼Œæ— ä¸ªäººä¿¡æ¯æ³„éœ²é£é™©ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…åç»­æäº¤å†²çª
          git pull origin ${{ inputs.target_branch || github.ref_name }}
          echo "âœ… Gitç¯å¢ƒæ ¡éªŒé€šè¿‡"

  # ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡èµ„æºæ ¡éªŒï¼ˆé¢„ä¸‹è½½éªŒè¯åœ°å€ã€å“ˆå¸Œï¼Œå¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼‰
  resource-validation:
    runs-on: ubuntu-latest
    name: å…¨é‡èµ„æºæœ‰æ•ˆæ€§ä¸å“ˆå¸Œæ ¡éªŒ
    needs: pre-flight-check
    steps:
      - name: æ£€å‡ºä»£ç ä¸ç»§æ‰¿ç¯å¢ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref_name }}
      - name: ç»§æ‰¿èµ„æºæ¸…å•
        run: |
          mkdir -p ${{ env.TEMP_DIR }}
          cat > ${{ env.TEMP_DIR }}/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|assets/js/|2f3a4c8e9b0d7f1a2c3e4d5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|assets/css/|7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|assets/js/|3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|assets/js/|4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡ï¼Œé€‚é…æ‰€æœ‰å±å¹•
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–æ ¸å¿ƒ
          EOF

      - name: æ‰¹é‡æ ¡éªŒèµ„æºåœ°å€ä¸å“ˆå¸Œï¼ˆå…¨é‡é€šè¿‡æ‰ä¼šè¿›å…¥ä¸‹è½½é˜¶æ®µï¼‰
        run: |
          echo "ğŸ” å¼€å§‹æ‰¹é‡æ ¡éªŒèµ„æºï¼Œå…± ${{ needs.pre-flight-check.outputs.resource_count }} ä¸ª"
          ERROR_COUNT=0
          while IFS='|' read -r NAME VERSION URL TARGET_PATH EXPECTED_HASH DESC; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ -z "$NAME" || "$NAME" == \#* ]] && continue
            echo -e "\n==================== æ ¡éªŒ $NAME ($VERSION) ===================="
            # 1. æ ¡éªŒåœ°å€å¯ç”¨æ€§ï¼ˆèœ˜è››æ¨¡å¼ï¼Œä¸ä¸‹è½½å®Œæ•´æ–‡ä»¶ï¼‰
            echo "1. æ ¡éªŒåœ°å€å¯ç”¨æ€§..."
            if ! wget --spider --timeout=15 --tries=2 "$URL" 2>/dev/null; then
              echo "âŒ åœ°å€ä¸å¯ç”¨: $URL"
              ERROR_COUNT=$((ERROR_COUNT+1))
              continue
            fi
            echo "âœ… åœ°å€å¯ç”¨"

            # 2. é¢„ä¸‹è½½æ ¡éªŒå“ˆå¸Œï¼ˆç¡®ä¿æ–‡ä»¶æœªè¢«ç¯¡æ”¹ï¼‰
            echo "2. æ ¡éªŒæ–‡ä»¶å“ˆå¸Œå®Œæ•´æ€§..."
            TEMP_FILE="${{ env.TEMP_DIR }}/$(basename "$URL")"
            wget -q -O "$TEMP_FILE" --timeout=20 --tries=3 "$URL"
            ACTUAL_HASH=$(sha256sum "$TEMP_FILE" | awk '{print $1}')
            
            if [ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]; then
              echo "âŒ å“ˆå¸Œä¸åŒ¹é…ï¼"
              echo "   é¢„æœŸå“ˆå¸Œ: $EXPECTED_HASH"
              echo "   å®é™…å“ˆå¸Œ: $ACTUAL_HASH"
              ERROR_COUNT=$((ERROR_COUNT+1))
              rm -f "$TEMP_FILE"
              continue
            fi
            echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡ï¼Œæ–‡ä»¶å®Œæ•´æœªç¯¡æ”¹"
            rm -f "$TEMP_FILE"
          done < ${{ env.TEMP_DIR }}/resource_manifest.list

          # ç»Ÿè®¡æ ¡éªŒç»“æœï¼Œæœ‰é”™è¯¯ç›´æ¥ç»ˆæ­¢å·¥ä½œæµ
          echo -e "\n==================== æ ¡éªŒç»“æœæ±‡æ€» ===================="
          if [ $ERROR_COUNT -ne 0 ]; then
            echo "âŒ æ ¡éªŒå¤±è´¥ï¼Œå…± $ERROR_COUNT ä¸ªèµ„æºå¼‚å¸¸ï¼Œå·¥ä½œæµç»ˆæ­¢"
            exit 1
          else
            echo "âœ… å…¨éƒ¨ ${{ needs.pre-flight-check.outputs.resource_count }} ä¸ªèµ„æºæ ¡éªŒé€šè¿‡ï¼Œæ— å¼‚å¸¸"
          fi

  # ç¬¬ä¸‰é˜¶æ®µï¼šèµ„æºä¸‹è½½ä¸éƒ¨ç½²ï¼ˆä»…å½“å‰é¢ä¸¤ä¸ªé˜¶æ®µå…¨éƒ¨é€šè¿‡æ‰ä¼šæ‰§è¡Œï¼‰
  resource-download-deploy:
    runs-on: ubuntu-latest
    name: èµ„æºä¸‹è½½ä¸éƒ¨ç½²
    needs: [pre-flight-check, resource-validation]
    steps:
      - name: æ£€å‡ºä»£ç ä¸ç»§æ‰¿ç¯å¢ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref_name }}
      - name: ç»§æ‰¿èµ„æºæ¸…å•
        run: |
          mkdir -p ${{ env.TEMP_DIR }}
          cat > ${{ env.TEMP_DIR }}/resource_manifest.list << 'EOF'
          KaTeX-æ ¸å¿ƒJS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js|assets/js/|2f3a4c8e9b0d7f1a2c3e4d5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5|EPUBæ•°å­¦å…¬å¼æ¸²æŸ“æ ¸å¿ƒ
          KaTeX-æ ¸å¿ƒCSS|v0.16.9|https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css|assets/css/|7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8|å…¬å¼æ¸²æŸ“é…å¥—æ ·å¼
          Zepto-è½»é‡DOMåº“|v1.2.0|https://cdn.jsdelivr.net/npm/zepto@1.2.0/dist/zepto.min.js|assets/js/|3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4|ç§»åŠ¨ç«¯DOMæ“ä½œï¼Œæ›¿ä»£jQuery
          epub.js-è§£ææ ¸å¿ƒ|v0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|assets/js/|4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5|EPUBæ ‡å‡†è§£æã€ç« èŠ‚åŠ è½½ã€ç¿»é¡µæ§åˆ¶
          Material-Icons-å›¾æ ‡å­—ä½“|v6.7.0|https://cdn.jsdelivr.net/npm/material-design-icons-iconfont@6.7.0/fonts/MaterialIcons-Regular.ttf|assets/fonts/|5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6|é˜…è¯»å™¨å…¨é‡çŸ¢é‡å›¾æ ‡ï¼Œé€‚é…æ‰€æœ‰å±å¹•
          Annotator-æ‰¹æ³¨æ ¸å¿ƒ|v2.0.1|https://cdn.jsdelivr.net/npm/annotator@2.0.1/dist/annotator.min.js|assets/js/|6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7|æ–‡æœ¬é€‰ä¸­ã€é«˜äº®ã€æ‰¹æ³¨æŒä¹…åŒ–æ ¸å¿ƒ
          EOF

      - name: æ‰¹é‡ä¸‹è½½èµ„æºï¼ˆå¹‚ç­‰æ€§å¤„ç†ï¼Œä»…å˜æ›´æ–‡ä»¶ï¼‰
        id: download
        run: |
          echo "ğŸ“¥ å¼€å§‹æ‰¹é‡ä¸‹è½½èµ„æºï¼Œå…± ${{ needs.pre-flight-check.outputs.resource_count }} ä¸ª"
          CHANGE_COUNT=0
          # ç”Ÿæˆæ¸…å•æ–‡ä»¶å¤´éƒ¨
          echo "# EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æºæ¸…å•" > ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          echo "ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          echo "è§¦å‘äºº: ${{ github.actor }}" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          echo "è¿è¡Œæ¨¡å¼: ${{ inputs.run_mode || 'auto-check' }}" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          echo -e "\n| èµ„æºåç§° | ç‰ˆæœ¬ | ç›®æ ‡è·¯å¾„ | SHA256å“ˆå¸Œ | ç”¨é€”è¯´æ˜ |" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          echo "|----------|------|----------|------------|----------|" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}

          while IFS='|' read -r NAME VERSION URL TARGET_PATH EXPECTED_HASH DESC; do
            [[ -z "$NAME" || "$NAME" == \#* ]] && continue
            echo -e "\n==================== å¤„ç† $NAME ($VERSION) ===================="
            
            # æ‹¼æ¥å®Œæ•´è·¯å¾„
            FULL_TARGET_DIR="${{ env.PROJECT_ROOT }}/$TARGET_PATH"
            FULL_TARGET_PATH="$FULL_TARGET_DIR$(basename "$URL")"
            mkdir -p "$FULL_TARGET_DIR"

            # å¹‚ç­‰æ€§åˆ¤æ–­ï¼šæ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œè·³è¿‡ä¸‹è½½
            if [ -f "$FULL_TARGET_PATH" ]; then
              EXISTING_HASH=$(sha256sum "$FULL_TARGET_PATH" | awk '{print $1}')
              if [ "$EXISTING_HASH" == "$EXPECTED_HASH" ] && [ "${{ inputs.force_override }}" != "true" ]; then
                echo "â„¹ï¸  æ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œè·³è¿‡ä¸‹è½½"
                # å†™å…¥æ¸…å•æ–‡ä»¶
                echo "| $NAME | $VERSION | $TARGET_PATH$(basename "$URL") | $EXPECTED_HASH | $DESC |" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
                continue
              fi
            fi

            # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•å’Œè¶…æ—¶ï¼‰
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½..."
            wget -q -O "$FULL_TARGET_PATH" --timeout=20 --tries=3 "$URL"
            
            # äºŒæ¬¡æ ¡éªŒä¸‹è½½åçš„æ–‡ä»¶
            ACTUAL_HASH=$(sha256sum "$FULL_TARGET_PATH" | awk '{print $1}')
            if [ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]; then
              echo "âŒ ä¸‹è½½åå“ˆå¸Œä¸åŒ¹é…ï¼Œæ–‡ä»¶å¼‚å¸¸ï¼Œè‡ªåŠ¨åˆ é™¤"
              rm -f "$FULL_TARGET_PATH"
              exit 1
            fi

            # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™ï¼ˆå®‰å…¨åˆè§„ï¼Œæ— å¤šä½™æ‰§è¡Œæƒé™ï¼‰
            chmod 644 "$FULL_TARGET_PATH"
            echo "âœ… ä¸‹è½½å®Œæˆï¼Œå·²éƒ¨ç½²åˆ° $FULL_TARGET_PATH"
            CHANGE_COUNT=$((CHANGE_COUNT+1))
            # å†™å…¥æ¸…å•æ–‡ä»¶
            echo "| $NAME | $VERSION | $TARGET_PATH$(basename "$URL") | $EXPECTED_HASH | $DESC |" >> ${{ env.PROJECT_ROOT }}/${{ env.MANIFEST_FILE }}
          done < ${{ env.TEMP_DIR }}/resource_manifest.list

          # è¾“å‡ºå˜æ›´æ•°é‡ï¼Œä¾›åç»­æ­¥éª¤åˆ¤æ–­
          echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
          echo -e "\n==================== ä¸‹è½½ç»“æœæ±‡æ€» ===================="
          echo "âœ… å¤„ç†å®Œæˆï¼Œå…±å˜æ›´ $CHANGE_COUNT ä¸ªæ–‡ä»¶"

      - name: å¤„ç†Dry-runæ¨¡å¼ï¼ˆé¢„æ¼”ç»“æŸï¼Œä¸ä¿®æ”¹ä»“åº“ï¼‰
        if: ${{ inputs.run_mode == 'dry-run' || github.event_name == 'push' }}
        run: |
          echo "ğŸ¯ å½“å‰ä¸º Dry-run é¢„æ¼”æ¨¡å¼ï¼Œä¸æäº¤ä»»ä½•å˜æ›´åˆ°ä»“åº“"
          echo "é¢„æ¼”ç»“æœï¼šæœ¬æ¬¡è¿è¡Œå°†å˜æ›´ ${{ steps.download.outputs.change_count }} ä¸ªæ–‡ä»¶"
          echo "å¦‚éœ€æ­£å¼æ‰§è¡Œï¼Œè¯·æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œé€‰æ‹© pr-mode æˆ– direct-push æ¨¡å¼"
          exit 0

      - name: æäº¤å˜æ›´åˆ°Git
        if: ${{ inputs.run_mode != 'dry-run' && github.event_name != 'push' && steps.download.outputs.change_count > 0 }}
        id: commit
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤å˜æ›´åˆ°Git"
          # ä»…æ·»åŠ é¡¹ç›®ç›®å½•ä¸‹çš„å†…å®¹ï¼Œä¸ç¢°ä»“åº“å…¶ä»–æ–‡ä»¶
          git add ${{ env.PROJECT_ROOT }}/
          # ç”Ÿæˆè§„èŒƒæäº¤ä¿¡æ¯
          COMMIT_MSG="chore(èµ„æºåŒæ­¥): è‡ªåŠ¨åŒæ­¥EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æº
          å˜æ›´æ–‡ä»¶æ•°é‡: ${{ steps.download.outputs.change_count }}
          è§¦å‘äºº: ${{ github.actor }}
          è¿è¡Œæ¨¡å¼: ${{ inputs.run_mode }}
          åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$COMMIT_MSG"
          # è¾“å‡ºæäº¤å“ˆå¸Œï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "âœ… å˜æ›´æäº¤å®Œæˆï¼Œæäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"

      - name: å¤„ç†PRæ¨¡å¼ï¼ˆåˆ›å»ºPRå¾…å®¡æ ¸åˆå¹¶ï¼‰
        if: ${{ inputs.run_mode == 'pr-mode' && steps.commit.outputs.commit_hash != '' }}
        run: |
          echo "ğŸ”€ å½“å‰ä¸ºPRæ¨¡å¼ï¼Œåˆ›å»ºä¸´æ—¶åˆ†æ”¯å¹¶ç”ŸæˆPull Request"
          # åˆ›å»ºä¸´æ—¶åˆ†æ”¯
          TEMP_BRANCH="feature/auto-resource-sync-$(date +%Y%m%d%H%M%S)"
          git checkout -b $TEMP_BRANCH
          # æ¨é€ä¸´æ—¶åˆ†æ”¯
          git push origin $TEMP_BRANCH
          # åˆ›å»ºPR
          gh pr create \
            --base ${{ inputs.target_branch }} \
            --head $TEMP_BRANCH \
            --title "è‡ªåŠ¨åŒæ­¥EPUBé˜…è¯»å™¨æ ¸å¿ƒèµ„æº" \
            --body "æœ¬æ¬¡åŒæ­¥ç”±GitHub Actionè‡ªåŠ¨è§¦å‘ï¼Œå…±å˜æ›´ ${{ steps.download.outputs.change_count }} ä¸ªæ ¸å¿ƒèµ„æºæ–‡ä»¶ã€‚
          æäº¤å“ˆå¸Œ: ${{ steps.commit.outputs.commit_hash }}
          è§¦å‘äºº: @${{ github.actor }}
          è¯·å®¡æ ¸ååˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚"
          echo "âœ… PRåˆ›å»ºå®Œæˆï¼Œå¾…å®¡æ ¸åˆå¹¶"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å¤„ç†ç›´æ¨æ¨¡å¼ï¼ˆç›´æ¥æ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ï¼‰
        if: ${{ inputs.run_mode == 'direct-push' && steps.commit.outputs.commit_hash != '' }}
        run: |
          echo "â¬†ï¸ å½“å‰ä¸ºç›´æ¨æ¨¡å¼ï¼Œç›´æ¥æ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ ${{ inputs.target_branch }}"
          git push origin ${{ inputs.target_branch }}
          echo "âœ… æ¨é€å®Œæˆï¼Œèµ„æºå·²åŒæ­¥åˆ°ç›®æ ‡åˆ†æ”¯"

  # ç¬¬å››é˜¶æ®µï¼šæ”¶å°¾æ¸…ç†ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼‰
  post-cleanup:
    runs-on: ubuntu-latest
    name: æ”¶å°¾æ¸…ç†
    needs: [pre-flight-check, resource-validation, resource-download-deploy]
    if: always()
    steps:
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶å·¥ä½œç›®å½•"
          rm -rf ${{ env.TEMP_DIR }}
          echo "âœ… æ¸…ç†å®Œæˆ"
