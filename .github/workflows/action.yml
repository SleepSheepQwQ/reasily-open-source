name: å®¡æ…é«˜å®¹é”™-å¼€æºä¾èµ–åŒæ­¥å·¥ä½œæµ
run-name: ä¾èµ–åŒæ­¥ ${{ inputs.dry_run && 'ã€é¢„æ ¡éªŒé¢„è§ˆã€‘' || 'ã€æ­£å¼æ‰§è¡Œã€‘' }} | è§¦å‘äºº: ${{ github.actor }}

# è§¦å‘è§„åˆ™ï¼ˆä¸¥æ ¼éš”ç¦»ï¼‰
on:
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶ï¼Œä»…æ‰§è¡Œé—¨ç¦é¢„æ ¡éªŒï¼Œä¸åšä»»ä½•ä»“åº“ä¿®æ”¹
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/sync-open-source-deps.yml'
  # ä»…æ‰‹åŠ¨è§¦å‘å¯æ‰§è¡Œæ­£å¼å˜æ›´ï¼Œæ”¯æŒå‚æ•°é…ç½®
  workflow_dispatch:
    inputs:
      dry_run:
        description: "é¢„æ ¡éªŒé¢„è§ˆæ¨¡å¼ï¼ˆä»…æ£€æŸ¥ä¸ä¿®æ”¹ä»“åº“ï¼‰"
        type: boolean
        default: true
        required: false
      create_pr:
        description: "æ­£å¼æ¨¡å¼ä¸‹æ˜¯å¦åˆ›å»ºPRï¼ˆå…³é—­åˆ™ä»…æœ¬åœ°å˜æ›´ä¸æäº¤ï¼‰"
        type: boolean
        default: true
        required: false
      force_update:
        description: "æ˜¯å¦å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆé»˜è®¤ä»…å“ˆå¸Œä¸åŒ¹é…æ—¶æ›´æ–°ï¼‰"
        type: boolean
        default: false
        required: false

# å…¨å±€æœ€å°æƒé™é…ç½®
permissions:
  contents: read
  pull-requests: write

# å…¨å±€Shellä¸¥æ ¼æ¨¡å¼ï¼ˆå®¹é”™æ ¸å¿ƒï¼šä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³ç»ˆæ­¢ï¼Œä¸ç»§ç»­æ‰§è¡Œï¼‰
defaults:
  run:
    shell: bash
    working-directory: ${{ github.workspace }}

jobs:
  sync-deps:
    runs-on: ubuntu-latest
    environment: production
    # è¶…æ—¶è‡ªåŠ¨ç»ˆæ­¢ï¼Œé¿å…å¡æ­»å ç”¨èµ„æº
    timeout-minutes: 10
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆå¹²å‡€ç¯å¢ƒï¼Œé¿å…æ®‹ç•™æ–‡ä»¶å¹²æ‰°ï¼‰
      - name: ğŸ” æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šå…¨å±€ç¯å¢ƒé¢„æ ¡éªŒï¼ˆå®¹é”™å‰ç½®ï¼šæ‰§è¡Œå‰å…ˆç¡®è®¤æ‰€æœ‰æ¡ä»¶æ»¡è¶³ï¼‰
      - name: ğŸ›¡ï¸ ç¯å¢ƒä¸é¡¹ç›®ç»“æ„é¢„æ ¡éªŒ
        run: |
          # Shellä¸¥æ ¼æ¨¡å¼ï¼ˆæ ¸å¿ƒå®¹é”™é…ç½®ï¼‰
          set -euo pipefail
          IFS=$'\n\t'

          echo "==================== ç¯å¢ƒé¢„æ ¡éªŒå¼€å§‹ ===================="
          
          # 1. æ£€æŸ¥å¿…è¦å·¥å…·æ˜¯å¦å­˜åœ¨
          REQUIRED_TOOLS=("wget" "curl" "sha256sum" "git" "mkdir" "rm" "mv" "ls")
          for TOOL in "${REQUIRED_TOOLS[@]}"; do
            if ! command -v "$TOOL" &> /dev/null; then
              echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å·¥å…· $TOOLï¼Œç¯å¢ƒä¸æ»¡è¶³æ‰§è¡Œè¦æ±‚"
              exit 1
            fi
            echo "âœ… å·¥å…·æ£€æŸ¥é€šè¿‡ï¼š$TOOL"
          done

          # 2. æ£€æŸ¥é¡¹ç›®æ ¸å¿ƒç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºï¼ˆå…¼å®¹ç©ºä»“åº“ï¼‰
          CORE_DIRS=(
            "epub-reader-light/assets/css"
            "epub-reader-light/assets/js"
            "epub-reader-light/assets/fonts"
            "epub-reader-light/assets/epubs"
          )
          for DIR in "${CORE_DIRS[@]}"; do
            if [ ! -d "$DIR" ]; then
              echo "âš ï¸  ç›®å½•ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºï¼š$DIR"
              mkdir -p "$DIR"
            fi
            echo "âœ… ç›®å½•æ£€æŸ¥é€šè¿‡ï¼š$DIR"
          done

          # 3. Gitç¯å¢ƒé…ç½®ï¼ˆé¿å…æ¢è¡Œç¬¦ã€ç¼–ç é—®é¢˜å¯¼è‡´å“ˆå¸Œæ ¡éªŒå¤±è´¥ï¼‰
          git config --global core.autocrlf false
          git config --global core.fileMode false
          git config --global core.quotepath off
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 4. æ‹‰å–æœ€æ–°ä¸»åˆ†æ”¯ä»£ç ï¼Œé¿å…åŸºäºæ—§ä»£ç æ‰§è¡Œå¯¼è‡´å†²çª
          git pull origin main --rebase

          echo "==================== ç¯å¢ƒé¢„æ ¡éªŒå…¨éƒ¨é€šè¿‡ ===================="

      # æ­¥éª¤3ï¼šä¾èµ–é…ç½®æ¸…å•ï¼ˆç»Ÿä¸€ç®¡ç†ï¼Œæ‰€æœ‰ä¾èµ–åœ¨æ­¤å¤„é…ç½®ï¼Œæ— éœ€ä¿®æ”¹æ‰§è¡Œé€»è¾‘ï¼‰
      # å“ˆå¸Œå€¼è·å–å‘½ä»¤ï¼šwget ä¸‹è½½åœ°å€ -O temp.file && sha256sum temp.file
      - name: ğŸ“‹ åŠ è½½ä¾èµ–é…ç½®æ¸…å•
        id: deps-config
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          # ä¾èµ–é…ç½®æ ¸å¿ƒåŒºï¼šæ–°å¢/ä¿®æ”¹ä¾èµ–ä»…éœ€ä¿®æ”¹æ­¤å¤„
          # æ ¼å¼ï¼šåç§°|ç‰ˆæœ¬|ä¸‹è½½åœ°å€|ç›®æ ‡è·¯å¾„|sha256å“ˆå¸Œå€¼
          cat > .tmp_deps_list << 'EOF'
          epub.js|0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|epub-reader-light/assets/js/epub.min.js|7e8e5b88d6e4b4e8f9a0d7b6c5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a
          # åç»­æ–°å¢ä¾èµ–ç›´æ¥åœ¨ä¸‹æ–¹æ·»åŠ ï¼Œç¤ºä¾‹ï¼š
          # ç¤ºä¾‹å­—ä½“|1.0|https://xxx.com/font.otf|epub-reader-light/assets/fonts/font.otf|å“ˆå¸Œå€¼
          EOF

          # è¿‡æ»¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œç”Ÿæˆæœ‰æ•ˆé…ç½®
          grep -v '^#' .tmp_deps_list | grep -v '^$' > .tmp_valid_deps
          echo "âœ… åŠ è½½æœ‰æ•ˆä¾èµ–é…ç½®ï¼š$(wc -l < .tmp_valid_deps) ä¸ª"

      # æ­¥éª¤4ï¼šæ ¸å¿ƒä¾èµ–æ‹‰å–+å®Œæ•´æ€§æ ¡éªŒï¼ˆå®¹é”™æ ¸å¿ƒï¼ŒåŸå­åŒ–æ“ä½œï¼Œå¤±è´¥ä¸æ±¡æŸ“ç°æœ‰æ–‡ä»¶ï¼‰
      - name: ğŸ“¥ ä¾èµ–æ‹‰å–ä¸å¼ºæ ¡éªŒ
        id: pull-deps
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          echo "==================== ä¾èµ–æ‹‰å–å¼€å§‹ ===================="
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•ï¼Œæ‰€æœ‰ä¸‹è½½å…ˆæ”¾ä¸´æ—¶ç›®å½•ï¼Œæ ¡éªŒé€šè¿‡æ‰ç§»åŠ¨åˆ°ç›®æ ‡è·¯å¾„
          TMP_DIR="./.tmp_deps_download"
          mkdir -p "$TMP_DIR"
          # å˜æ›´è®°å½•æ–‡ä»¶ï¼Œç”¨äºåç»­ç”ŸæˆPRæŠ¥å‘Š
          CHANGE_LOG="./.tmp_change_log.md"
          echo "# ä¾èµ–åŒæ­¥å˜æ›´æŠ¥å‘Š" > "$CHANGE_LOG"
          echo "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> "$CHANGE_LOG"
          echo "è§¦å‘äººï¼š${{ github.actor }}" >> "$CHANGE_LOG"
          echo "" >> "$CHANGE_LOG"
          echo "| ä¾èµ–åç§° | ç‰ˆæœ¬ | å˜æ›´ç±»å‹ | ç›®æ ‡è·¯å¾„ | æ ¡éªŒçŠ¶æ€ |" >> "$CHANGE_LOG"
          echo "| -------- | ---- | -------- | -------- | -------- |" >> "$CHANGE_LOG"

          # å…¨å±€å˜æ›´æ ‡è®°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          HAS_CHANGE=false
          FORCE_UPDATE=${{ inputs.force_update || 'false' }}

          # å¾ªç¯å¤„ç†æ¯ä¸ªä¾èµ–
          while IFS='|' read -r NAME VERSION URL TARGET_PATH EXPECTED_SHA; do
            # å»é™¤é¦–å°¾ç©ºæ ¼
            NAME=$(echo "$NAME" | xargs)
            VERSION=$(echo "$VERSION" | xargs)
            URL=$(echo "$URL" | xargs)
            TARGET_PATH=$(echo "$TARGET_PATH" | xargs)
            EXPECTED_SHA=$(echo "$EXPECTED_SHA" | xargs)

            echo ""
            echo "==================== å¤„ç†ä¾èµ–ï¼š$NAME v$VERSION ===================="

            # 1. è‡ªåŠ¨åˆ›å»ºç›®æ ‡æ–‡ä»¶æ‰€åœ¨ç›®å½•
            TARGET_DIR=$(dirname "$TARGET_PATH")
            mkdir -p "$TARGET_DIR"

            # 2. æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œä¸”å“ˆå¸ŒåŒ¹é…ï¼ˆå¹‚ç­‰æ€§ï¼šè·³è¿‡å·²æ­£ç¡®å­˜åœ¨çš„æ–‡ä»¶ï¼‰
            if [ -f "$TARGET_PATH" ]; then
              CURRENT_SHA=$(sha256sum "$TARGET_PATH" | awk '{print $1}')
              if [ "$CURRENT_SHA" == "$EXPECTED_SHA" ] && [ "$FORCE_UPDATE" != "true" ]; then
                echo "âœ… æ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œè·³è¿‡å¤„ç†ï¼š$TARGET_PATH"
                echo "| $NAME | $VERSION | æ— å˜æ›´ | $TARGET_PATH | æ ¡éªŒé€šè¿‡ |" >> "$CHANGE_LOG"
                continue
              fi
            fi

            # 3. ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ï¼ˆç½‘ç»œå¤±è´¥è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œé—´éš”5ç§’ï¼‰
            TMP_FILE="$TMP_DIR/$(basename "$TARGET_PATH")"
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ï¼š$URL"
            if ! wget --tries=3 --wait=5 --timeout=10 -O "$TMP_FILE" "$URL"; then
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$NAME v$VERSIONï¼Œç½‘ç»œå¼‚å¸¸æˆ–åœ°å€æ— æ•ˆ"
              exit 1
            fi

            # 4. æ ¡éªŒæ–‡ä»¶æ˜¯å¦ä¸ºç©ºï¼ˆé¿å…ä¸‹è½½åˆ°404é¡µé¢ã€ç©ºæ–‡ä»¶ï¼‰
            FILE_SIZE=$(stat -c%s "$TMP_FILE")
            if [ "$FILE_SIZE" -lt 1024 ]; then
              echo "âŒ æ–‡ä»¶å¼‚å¸¸ï¼š$NAME v$VERSIONï¼Œæ–‡ä»¶å¤§å°ä»… $FILE_SIZE å­—èŠ‚ï¼Œå°äº1KBæœ€å°é˜ˆå€¼"
              exit 1
            fi

            # 5. å¼ºæ ¡éªŒSHA256å“ˆå¸Œå€¼ï¼ˆé˜²æ­¢æ–‡ä»¶ç¯¡æ”¹ã€æŸåã€ç‰ˆæœ¬ä¸åŒ¹é…ï¼‰
            ACTUAL_SHA=$(sha256sum "$TMP_FILE" | awk '{print $1}')
            if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
              echo "âŒ å“ˆå¸Œæ ¡éªŒå¤±è´¥ï¼š$NAME v$VERSION"
              echo "   æœŸæœ›å“ˆå¸Œï¼š$EXPECTED_SHA"
              echo "   å®é™…å“ˆå¸Œï¼š$ACTUAL_SHA"
              echo "   è¯·æ£€æŸ¥ä¸‹è½½åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ›´æ–°é…ç½®ä¸­çš„å“ˆå¸Œå€¼"
              exit 1
            fi

            # 6. æ ¡éªŒé€šè¿‡ï¼ŒåŸå­åŒ–ç§»åŠ¨åˆ°ç›®æ ‡è·¯å¾„ï¼ˆè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆä¸ä¿®æ”¹åŸæ–‡ä»¶ï¼‰
            mv -f "$TMP_FILE" "$TARGET_PATH"
            echo "âœ… ä¾èµ–å¤„ç†å®Œæˆï¼š$NAME v$VERSION -> $TARGET_PATH"

            # 7. è®°å½•å˜æ›´
            if [ -f "$TARGET_PATH" ] && [ "$CURRENT_SHA" != "$EXPECTED_SHA" ]; then
              if [ -z "${CURRENT_SHA:-}" ]; then
                CHANGE_TYPE="æ–°å¢"
              else
                CHANGE_TYPE="æ›´æ–°"
              fi
              echo "| $NAME | $VERSION | $CHANGE_TYPE | $TARGET_PATH | æ ¡éªŒé€šè¿‡ |" >> "$CHANGE_LOG"
              HAS_CHANGE=true
            fi

          done < .tmp_valid_deps

          # è¾“å‡ºç»“æœåˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "has_change=$HAS_CHANGE" >> "$GITHUB_OUTPUT"
          echo "change_log_path=$CHANGE_LOG" >> "$GITHUB_OUTPUT"
          echo "tmp_dir=$TMP_DIR" >> "$GITHUB_OUTPUT"

          echo ""
          echo "==================== ä¾èµ–æ‹‰å–å…¨éƒ¨å®Œæˆ ===================="
          if [ "$HAS_CHANGE" == "true" ]; then
            echo "â„¹ï¸  æœ¬æ¬¡æ‰§è¡Œæœ‰å˜æ›´ï¼Œè¯¦æƒ…è§å˜æ›´æŠ¥å‘Š"
            cat "$CHANGE_LOG"
          else
            echo "â„¹ï¸  æœ¬æ¬¡æ‰§è¡Œæ— ä»»ä½•å˜æ›´ï¼Œæ‰€æœ‰ä¾èµ–å‡å·²ä¸ºæœ€æ–°æ­£ç¡®ç‰ˆæœ¬"
          fi

      # æ­¥éª¤5ï¼šé¢„æ ¡éªŒæ¨¡å¼æ”¶å°¾ï¼ˆä»…è¾“å‡ºç»“æœï¼Œä¸ä¿®æ”¹ä»“åº“ï¼‰
      - name: ğŸ“ é¢„æ ¡éªŒæ¨¡å¼ç»“æœè¾“å‡º
        if: inputs.dry_run == true
        run: |
          set -euo pipefail
          echo "==================== é¢„æ ¡éªŒé¢„è§ˆæ‰§è¡Œå®Œæˆ ===================="
          echo "âœ… æ‰€æœ‰ä¾èµ–æ ¡éªŒé€šè¿‡ï¼Œæ— æ‰§è¡Œé”™è¯¯"
          echo "â„¹ï¸  æœ¬æ¬¡ä¸ºé¢„æ ¡éªŒé¢„è§ˆæ¨¡å¼ï¼Œæœªå¯¹ä»“åº“è¿›è¡Œä»»ä½•ä¿®æ”¹"
          echo "â„¹ï¸  å¦‚éœ€æ­£å¼æ‰§è¡Œï¼Œè¯·å…³é—­ã€Œé¢„æ ¡éªŒé¢„è§ˆæ¨¡å¼ã€é‡æ–°è§¦å‘"
          echo ""
          echo "===== å˜æ›´é¢„è§ˆ ====="
          cat "${{ steps.pull-deps.outputs.change_log_path }}"

      # æ­¥éª¤6ï¼šæ­£å¼æ¨¡å¼-åˆ›å»ºä¸´æ—¶åˆ†æ”¯+æäº¤å˜æ›´ï¼ˆä¸ç›´æ¥ç¢°ä¸»åˆ†æ”¯ï¼‰
      - name: ğŸŒ¿ æ­£å¼æ¨¡å¼-åˆ›å»ºå˜æ›´åˆ†æ”¯
        if: inputs.dry_run == false && steps.pull-deps.outputs.has_change == 'true'
        id: create-branch
        run: |
          set -euo pipefail
          # ç”Ÿæˆå”¯ä¸€åˆ†æ”¯åï¼Œå¸¦æ—¶é—´æˆ³ï¼Œé¿å…å†²çª
          BRANCH_NAME="auto-update-deps/$(date '+%Y%m%d-%H%M%S')"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          
          # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°ä¸´æ—¶åˆ†æ”¯
          git checkout -b "$BRANCH_NAME"
          
          # æ·»åŠ å˜æ›´æ–‡ä»¶
          git add epub-reader-light/assets/
          
          # æäº¤å˜æ›´
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°å¼€æºä¾èµ– [$(date '+%Y-%m-%d %H:%M')]"
          
          echo "âœ… å˜æ›´å·²æäº¤åˆ°ä¸´æ—¶åˆ†æ”¯ï¼š$BRANCH_NAME"

      # æ­¥éª¤7ï¼šæ­£å¼æ¨¡å¼-åˆ›å»ºPRåˆ°ä¸»åˆ†æ”¯ï¼ˆäººå·¥å®¡æ ¸ååˆå¹¶ï¼Œå®¹é”™å…œåº•ï¼‰
      - name: ğŸ“¬ æ­£å¼æ¨¡å¼-åˆ›å»ºå®¡æ ¸PR
        if: inputs.dry_run == false && inputs.create_pr == true && steps.pull-deps.outputs.has_change == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.create-branch.outputs.branch_name }}
          base: main
          title: "chore: è‡ªåŠ¨æ›´æ–°å¼€æºä¾èµ– [$(date '+%Y-%m-%d')]"
          body-path: ${{ steps.pull-deps.outputs.change_log_path }}
          labels: |
            dependencies
            automated
          delete-branch: true

      # æ­¥éª¤8ï¼šå…¨æµç¨‹æ”¶å°¾-æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆæ— è®ºæˆåŠŸ/å¤±è´¥éƒ½æ‰§è¡Œï¼Œä¸ç•™ä¸‹è„æ•°æ®ï¼‰
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf .tmp_* ./tmp_deps_download
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      # æ­¥éª¤9ï¼šæœ€ç»ˆç»“æœè¾“å‡º
      - name: ğŸ‰ æ‰§è¡Œå®Œæˆç»“æœæ±‡æ€»
        run: |
          echo "==================== å·¥ä½œæµæ‰§è¡Œå®Œæˆ ===================="
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âœ… é¢„æ ¡éªŒæ¨¡å¼æ‰§è¡ŒæˆåŠŸï¼Œæ— é”™è¯¯"
          else
            if [ "${{ steps.pull-deps.outputs.has_change }}" == "true" ]; then
              echo "âœ… æ­£å¼æ¨¡å¼æ‰§è¡ŒæˆåŠŸ"
              if [ "${{ inputs.create_pr }}" == "true" ]; then
                echo "âœ… PRå·²åˆ›å»ºï¼Œè¯·å‰å¾€ä»“åº“å®¡æ ¸åˆå¹¶"
              else
                echo "âœ… å˜æ›´å·²æäº¤åˆ°æœ¬åœ°åˆ†æ”¯ï¼Œæœªåˆ›å»ºPR"
              fi
            else
              echo "âœ… æ‰§è¡ŒæˆåŠŸï¼Œæ— ä¾èµ–å˜æ›´éœ€è¦å¤„ç†"
            fi
          fi
