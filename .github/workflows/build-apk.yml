name: Reasley安卓APP打包
on:
  push:
    branches: [ main ]
    # 核心修复：改工作流文件本身也会触发，同时只监听核心代码变更，避免无效触发
    paths:
      - 'app/**'
      - 'epub-reader-light/**'
      - '*.gradle.kts'
      - 'gradle.properties'
      - 'gradlew'
      - 'gradle/wrapper/**'
      - '.github/workflows/**'
    # 忽略无关文件变更，不触发打包
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '**.py'
  # 保留手动触发兜底，任何时候都能手动启动打包
  workflow_dispatch:

# 显式声明权限，避免仓库全局设置导致的权限问题
permissions:
  contents: read
  packages: write
  actions: write

jobs:
  build-release-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      # 步骤1：拉取代码，用稳定版v4，参数明确
      - name: 拉取仓库代码
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      # 步骤2：配置JDK环境，固定版本，稳定兼容
      - name: 配置JDK 17环境
        id: setup-java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 步骤3：配置Android SDK，用稳定版官方Action
      - name: 配置Android SDK环境
        id: setup-android
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 9477386

      # 步骤4：同步前端资源，加校验日志，确认资源存在
      - name: 同步前端阅读器资源
        id: sync-frontend
        run: |
          mkdir -p app/src/main/assets/www
          if [ -d "epub-reader-light" ]; then
            cp -r epub-reader-light/* app/src/main/assets/www/
            echo "✅ 前端资源同步完成，文件列表："
            ls -la app/src/main/assets/www/
          else
            echo "⚠️  前端目录epub-reader-light不存在，跳过同步"
          fi

      # 步骤5：生成调试签名文件，加-noprompt避免交互阻塞，参数完整
      - name: 生成签名文件
        id: generate-keystore
        run: |
          keytool -genkey -v \
            -keystore app/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -noprompt
          echo "✅ 签名文件生成完成"
          ls -la app/debug.keystore

      # 步骤6：授予执行权限，加校验
      - name: 授予Gradle执行权限
        id: chmod-gradlew
        run: |
          chmod +x gradlew
          echo "✅ 权限授予完成，gradlew状态："
          ls -la gradlew

      # 步骤7：构建Release APK，加完整日志，无守护进程，稳定构建
      - name: 构建Release安装包
        id: build-apk
        run: ./gradlew assembleRelease --stacktrace --info --no-daemon

      # 步骤8：上传APK产物，固定版本，参数完整，保留30天
      - name: 上传APK安装包
        id: upload-apk
        uses: actions/upload-artifact@v4
        with:
          name: Reasley-Release-APK
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: error
