name: Reasley 安卓APP构建
on:
  # 推送main分支触发，严格匹配路径，改工作流本身也会触发
  push:
    branches:
      - main
    paths:
      - app/**
      - epub-reader-light/**
      - *.gradle.kts
      - gradle.properties
      - gradlew
      - gradle/wrapper/**
      - .github/workflows/**
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "**.py"
  # 手动触发兜底，100%可随时执行
  workflow_dispatch:

# 最小必要权限，严格遵循GitHub安全规范
permissions:
  contents: read

jobs:
  build:
    name: 构建Release安装包
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. 拉取代码：官方标准Action，固定稳定版
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      # 2. 配置Java环境：官方标准Action，固定版本，兼容Gradle
      - name: 配置JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # 3. 授予gradlew执行权限：提前处理，避免后续权限报错
      - name: 配置Gradle执行权限
        run: chmod +x gradlew

      # 4. Gradle构建：官方维护的标准Action，自动处理缓存、依赖、环境兼容
      - name: Gradle构建Release包
        uses: gradle/gradle-build-action@v3
        with:
          arguments: assembleRelease
          cache-read-only: false
          gradle-home-cache-cleanup: true

      # 5. 自动生成调试签名（兼容无自定义签名的场景）
      - name: 生成调试签名文件
        if: success()
        run: |
          keytool -genkey -v -keystore app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US" -noprompt
          echo "签名文件生成完成"

      # 6. 同步前端资源到安卓项目：严谨脚本，带校验
      - name: 同步前端阅读器资源
        if: success()
        run: |
          TARGET_DIR="app/src/main/assets/www"
          mkdir -p ${TARGET_DIR}
          if [ -d "epub-reader-light" ]; then
            cp -R epub-reader-light/* ${TARGET_DIR}/
            echo "✅ 前端资源同步完成，文件清单："
            ls -lh ${TARGET_DIR}/
          else
            echo "⚠️  前端目录不存在，跳过同步"
          fi

      # 7. 上传APK产物：官方标准Action，固定稳定版
      - name: 上传Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Reasley-Release-APK
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
          compression-level: 9

      # 8. 失败兜底：上传构建日志，方便排查问题
      - name: 上传构建失败日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: app/build/reports/
          retention-days: 7
