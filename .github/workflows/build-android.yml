---
name: Reasley安卓APP构建
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: read
jobs:
  build-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置JDK17环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 兜底1：自动修复gradlew，语法错误直接重生成
      - name: 修复Gradle执行环境
        run: |
          chmod +x gradlew
          bash -n gradlew
          if [ $? -ne 0 ]; then
            echo "⚠️  gradlew损坏，自动重新生成"
            gradle wrapper --gradle-version 8.2
            chmod +x gradlew
          fi
          echo "✅ gradlew环境验证通过"

      # 兜底2：自动生成签名文件，避免构建失败
      - name: 生成调试签名
        run: |
          keytool -genkey -v -keystore app/debug.keystore \
            -alias androiddebugkey -keyalg RSA -keysize 2048 \
            -validity 10000 -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" -noprompt

      # 同步你的前端阅读器资源
      - name: 同步前端界面资源
        run: |
          mkdir -p app/src/main/assets/www
          if [ -d "epub-reader-light" ]; then
            cp -r epub-reader-light/* app/src/main/assets/www/
            echo "✅ 前端资源同步完成"
          fi

      # 用Gradle官方维护的标准Action构建，自动处理环境兼容
      - name: 构建Release安装包
        uses: gradle/gradle-build-action@v3
        with:
          arguments: assembleRelease
          cache-read-only: false

      # 上传可安装的APK
      - name: 上传Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Reasley-Release-APK
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      # 失败时自动上传日志，方便排查
      - name: 上传构建失败日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs
          path: app/build/reports/
