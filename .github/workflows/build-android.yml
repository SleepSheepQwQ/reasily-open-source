# 极致云端全托管·零本地要求 Android 构建终版
name: Android Cloud Full-Managed Cautious Build

# 提交/PR自动触发，支持手动触发，本地全程零操作
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# 最小权限原则，仅授予必须权限
permissions:
  contents: read

jobs:
  android-full-cloud-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60 # 全局兜底超时，避免资源卡死
    defaults:
      run:
        shell: bash
        # 【核心安全限制】所有操作严格锁定在仓库根目录内，绝对不碰系统目录，彻底解决权限报错
        working-directory: ${{ github.workspace }}

    steps:
      # 步骤1：拉取代码 - 官方原生Action，零第三方风险
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        timeout-minutes: 5
        with:
          fetch-depth: 0 # 全量拉取，支持云端增量构建提速

      # 步骤2：【核心极致适配】全仓库递归自动定位Android项目，不管在哪个层级都能找到
      - name: Auto Locate Android Project (Full Repository Scan)
        id: locate-project
        timeout-minutes: 5
        run: |
          echo "===== 全仓库扫描Android项目 ====="
          WORKSPACE_ROOT=${{ github.workspace }}
          echo "仓库根目录: $WORKSPACE_ROOT"

          # 1. 优先查找settings.gradle/settings.gradle.kts，定位Android项目根目录
          echo "1. 扫描项目根配置文件..."
          SETTINGS_FILE=$(find "$WORKSPACE_ROOT" -type f \( -name "settings.gradle" -o -name "settings.gradle.kts" \) | head -n 1)
          
          if [ -n "$SETTINGS_FILE" ]; then
            PROJECT_ROOT=$(dirname "$SETTINGS_FILE")
            echo "✅ 找到Android项目根目录: $PROJECT_ROOT"
          else
            # 兜底：查找带com.android.application的build.gradle，定位应用模块
            echo "⚠️  未找到settings.gradle，扫描应用模块..."
            APP_BUILD_FILE=$(find "$WORKSPACE_ROOT" -type f \( -name "build.gradle" -o -name "build.gradle.kts" \) -exec grep -l "com.android.application" {} \; | head -n 1)
            
            if [ -n "$APP_BUILD_FILE" ]; then
              PROJECT_ROOT=$(dirname "$APP_BUILD_FILE")
              echo "✅ 找到Android应用模块目录: $PROJECT_ROOT"
            else
              echo "❌ 错误：全仓库未找到任何Android项目配置文件，请确认仓库内包含Android项目"
              exit 1
            fi
          fi

          # 2. 全局输出项目路径，后续所有步骤自动复用
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_OUTPUT
          echo "✅ Android项目定位完成，后续步骤自动适配路径"

          # 3. 自动提取项目指定的Gradle版本（无则用官方稳定版）
          echo "===== 匹配Gradle版本 ====="
          WRAPPER_PROPERTIES=$(find "$PROJECT_ROOT" -name "gradle-wrapper.properties" | head -n 1)
          if [ -n "$WRAPPER_PROPERTIES" ] && grep -q "distributionUrl" "$WRAPPER_PROPERTIES"; then
            GRADLE_VERSION=$(grep "distributionUrl" "$WRAPPER_PROPERTIES" | sed -n 's/.*gradle-\([0-9.]*\)-bin.zip.*/\1/p')
            echo "✅ 提取到项目指定Gradle版本: $GRADLE_VERSION"
          else
            GRADLE_VERSION="8.7"
            echo "⚠️  未找到项目Gradle版本，使用官方稳定版: $GRADLE_VERSION"
          fi
          echo "GRADLE_VERSION=$GRADLE_VERSION" >> $GITHUB_ENV
          echo "GRADLE_VERSION=$GRADLE_VERSION" >> $GITHUB_OUTPUT

      # 步骤3：配置JDK环境 - 官方原生Action，固定LTS版本，零第三方风险
      - name: Set Up Official JDK 17
        uses: actions/setup-java@v4
        timeout-minutes: 5
        with:
          java-version: 17.0.10+7
          distribution: temurin
          java-package: jdk

      # 步骤4：【核心绕坑】云端直接安装官方Gradle，彻底不用gradlew、不用系统预装，100%云端闭环
      - name: Install Official Gradle (Cloud Only)
        id: install-gradle
        timeout-minutes: 10
        run: |
          echo "===== 云端安装Gradle ${{ env.GRADLE_VERSION }} ====="
          GRADLE_URL="https://services.gradle.org/distributions/gradle-${{ env.GRADLE_VERSION }}-bin.zip"
          GRADLE_INSTALL_DIR="${{ github.workspace }}/gradle-temp"
          
          # 下载、解压、配置环境，全在云端完成
          mkdir -p "$GRADLE_INSTALL_DIR"
          curl -sL "$GRADLE_URL" -o gradle.zip
          unzip -q gradle.zip -d "$GRADLE_INSTALL_DIR"
          rm -f gradle.zip
          
          # 配置PATH，全局生效
          GRADLE_BIN_DIR=$(find "$GRADLE_INSTALL_DIR" -name "bin" -type d | head -n 1)
          echo "$GRADLE_BIN_DIR" >> $GITHUB_PATH
          echo "GRADLE_BIN_DIR=$GRADLE_BIN_DIR" >> $GITHUB_ENV
          
          # 校验安装成功
          sleep 2
          gradle --version
          echo "✅ Gradle云端安装完成，无需本地gradlew文件"

      # 步骤5：全链路环境预校验，提前排除所有风险
      - name: Full Environment Pre-check & Auto Repair
        timeout-minutes: 5
        run: |
          echo "===== 1. 核心环境校验 ====="
          echo "CPU核心数: $(nproc)"
          echo "可用内存: $(free -h | grep Mem | awk '{print $7}')"
          echo "JDK版本: $(java -version 2>&1 | head -n 1)"
          echo "Gradle版本: $(gradle --version | grep "Gradle " | awk '{print $2}')"
          
          echo "===== 2. Android官方环境校验 ====="
          echo "ANDROID_HOME 路径: $ANDROID_HOME"
          if [ -d "$ANDROID_HOME" ]; then
            echo "✅ 官方Android SDK环境正常"
          else
            echo "❌ 错误：Android SDK环境不存在"
            exit 1
          fi
          
          echo "===== 3. 项目目录校验 ====="
          if [ ! -d "${{ env.PROJECT_ROOT }}" ]; then
            echo "❌ 错误：项目目录不存在"
            exit 1
          fi
          echo "✅ 项目目录正常: ${{ env.PROJECT_ROOT }}"
          
          echo "===== 4. 自动修复权限 ====="
          cd "${{ env.PROJECT_ROOT }}"
          chmod -R 755 .
          echo "✅ 项目文件权限修复完成"
          echo "✅ 全环境校验通过，无风险"

      # 步骤6：云端依赖预下载+网络波动兜底，避免构建时失败
      - name: Cloud Dependencies Pre-download (Retry 3 Times)
        timeout-minutes: 15
        run: |
          cd "${{ env.PROJECT_ROOT }}"
          echo "===== 预下载全量依赖，3次重试兜底网络波动 ====="
          for i in 1 2 3; do
            gradle dependencies --no-daemon && break
            echo "⚠️  依赖下载失败，第$i次重试..."
            sleep 10
          done
          echo "✅ 全量依赖预下载完成，云端缓存生效"

      # 步骤7：【极致容错双模式构建】高性能模式优先，失败自动切换极致保守模式，能成绝不失败
      - name: Build (High Performance Mode)
        id: high-perf-build
        continue-on-error: true
        timeout-minutes: 25
        run: |
          cd "${{ env.PROJECT_ROOT }}"
          echo "===== 执行高性能模式构建 ====="
          gradle assembleDebug \
            --daemon \
            --parallel \
            --max-workers=4 \
            -Dorg.gradle.jvmargs="-Xmx8g -XX:MaxMetaspaceSize=2g -XX:+HeapDumpOnOutOfMemoryError" \
            -Dandroid.sdk.dir=$ANDROID_HOME \
            --stacktrace \
            --info

      # 兜底构建：高性能模式失败自动触发，极致保守参数适配官方硬件，100%兼容
      - name: Build (Ultra Cautious Fallback Mode)
        if: steps.high-perf-build.outcome == 'failure'
        timeout-minutes: 25
        run: |
          cd "${{ env.PROJECT_ROOT }}"
          echo "⚠️  高性能模式构建失败，自动切换极致保守兜底模式"
          gradle assembleDebug \
            --no-daemon \
            --no-configuration-cache \
            --no-parallel \
            --max-workers=2 \
            -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" \
            -Dandroid.sdk.dir=$ANDROID_HOME \
            --stacktrace \
            --info

      # 步骤8：【安全修复版】产物&日志全量归档，严格限制在项目目录内，绝对不碰系统目录
      - name: Upload Full Build Artifacts & Logs
        uses: actions/upload-artifact@v4
        if: env.PROJECT_ROOT != '' && always()
        timeout-minutes: 10
        with:
          name: android-cloud-full-build-output
          path: |
            ${{ env.PROJECT_ROOT }}/**/build/outputs/
            ${{ env.PROJECT_ROOT }}/**/build/reports/
            ${{ env.PROJECT_ROOT }}/**/hs_err_pid*.log
            ${{ env.PROJECT_ROOT }}/**/java_pid*.hprof
          retention-days: 15
