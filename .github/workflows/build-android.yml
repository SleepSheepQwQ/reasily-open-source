# 绝对保守·官方标准 Android 构建工作流
# 完全遵循GitHub Actions官方YAML规范，零语法风险
name: Android Conservative Standard Build

# 触发规则：官方标准配置，无复杂过滤
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# 最小权限原则，官方推荐配置
permissions:
  contents: read

jobs:
  android-standard-build:
    # 固定稳定运行环境，禁用滚动更新的latest，避免环境突变
    runs-on: ubuntu-22.04
    # 全局超时兜底，官方推荐配置
    timeout-minutes: 40
    # 全局默认配置，严格锁定工作目录，避免系统路径访问
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      # 步骤1：拉取代码 - 官方原生Action，固定稳定版本，零第三方风险
      - name: Checkout Code
        uses: actions/checkout@v4
        timeout-minutes: 5
        with:
          fetch-depth: 1

      # 步骤2：配置JDK环境 - 官方原生Action，固定LTS版本，完全对齐Android官方兼容要求
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        timeout-minutes: 5
        with:
          java-version: 17.0.10+7
          distribution: temurin
          cache: gradle

      # 步骤3：自动适配项目路径 - 极简逻辑，仅覆盖99%常规项目场景，无复杂扫描，无语法风险
      - name: Auto Adapt Project Path
        id: project-path
        timeout-minutes: 2
        run: |
          # 仅检查2种最常规的项目结构，无复杂find循环
          if [ -f "./gradlew" ]; then
            PROJECT_DIR="./"
            echo "✅ 根目录项目，工作目录锁定"
          elif [ -f "./android/gradlew" ]; then
            PROJECT_DIR="./android"
            echo "✅ android子目录项目，工作目录锁定"
          else
            echo "❌ 未找到gradlew文件，请确认项目结构"
            exit 1
          fi
          # 全局输出路径，后续步骤复用
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # 步骤4：环境预校验 - 极简检查，提前暴露核心问题，无复杂逻辑
      - name: Pre-check Environment
        timeout-minutes: 2
        run: |
          # 检查项目目录
          if [ ! -d "${{ env.PROJECT_DIR }}" ]; then
            echo "❌ 项目目录不存在"
            exit 1
          fi
          # 检查gradlew权限并修复
          chmod +x ${{ env.PROJECT_DIR }}/gradlew
          echo "✅ gradlew权限修复完成"
          # 检查Android SDK环境
          if [ ! -d "$ANDROID_HOME" ]; then
            echo "❌ Android SDK环境异常"
            exit 1
          fi
          echo "✅ Android SDK环境正常"
          echo "✅ 全环境预校验通过"

      # 步骤5：Gradle环境校验 - 官方标准操作，确认环境正常
      - name: Verify Gradle Environment
        timeout-minutes: 5
        run: |
          cd ${{ env.PROJECT_DIR }}
          ./gradlew --version
          echo "✅ Gradle环境校验通过"

      # 步骤6：核心构建 - 官方标准保守参数，适配GitHub官方硬件，无激进配置
      - name: Build Android Project
        timeout-minutes: 25
        run: |
          cd ${{ env.PROJECT_DIR }}
          ./gradlew assembleDebug \
            --no-daemon \
            --max-workers=2 \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g" \
            --stacktrace

      # 步骤7：产物归档 - 官方原生Action，路径严格锁定，无系统目录访问风险
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        timeout-minutes: 5
        with:
          name: android-build-output
          path: ${{ env.PROJECT_DIR }}/app/build/outputs/
          retention-days: 7
