name: Reasleyå®‰å“APPæ„å»º
on:
  push:
    branches: [ main ]
    # é¿å…éä»£ç ä¿®æ”¹è§¦å‘æ„å»ºï¼Œå¯æ ¹æ®éœ€è¦åˆ é™¤
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘
permissions:
  contents: read
  packages: read
# å…¨å±€ç‰ˆæœ¬ç»Ÿä¸€ç®¡ç†ï¼Œä¿®æ”¹ä¸€å¤„å…¨é‡ç”Ÿæ•ˆ
env:
  GRADLE_VERSION: 8.2
  JDK_VERSION: 17
  ANDROID_COMPILE_SDK: 34
  ANDROID_BUILD_TOOLS: 34.0.0
  ANDROID_TARGET_SDK: 34
  ANDROID_MIN_SDK: 21
  KEYSTORE_PATH: app/debug.keystore
  KEYSTORE_ALIAS: androiddebugkey
  KEYSTORE_PASSWORD: android
jobs:
  build-release-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 25 # åˆç†è¶…æ—¶ï¼Œé¿å…å¡æ­»å ç”¨èµ„æº
    # æ­¥éª¤çº§å¤±è´¥é‡è¯•ï¼Œç½‘ç»œæ³¢åŠ¨ç­‰å¶å‘é—®é¢˜è‡ªåŠ¨é‡è¯•
    strategy:
      fail-fast: false
      max-parallel: 1
    steps:
      # 1. æ£€å‡ºä»£ç ï¼Œå¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•ï¼Œé¿å…æ®‹ç•™æ–‡ä»¶å¹²æ‰°
      - name: ğŸ” æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1
        timeout-minutes: 2

      # 2. é…ç½®JDK 17ï¼ˆGradle 8.2 å®˜æ–¹å¼ºåˆ¶è¦æ±‚çš„æœ€ä½å…¼å®¹ç‰ˆæœ¬ï¼‰
      - name: â˜• é…ç½®JDK 17ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'
          cache: 'gradle' # è‡ªåŠ¨ç¼“å­˜Gradleä¾èµ–ã€wrapperï¼Œå¤§å¹…æé€Ÿ+é™ä½ç½‘ç»œå¤±è´¥ç‡
        timeout-minutes: 5

      # 3. é…ç½®Android SDKï¼ˆä¹‹å‰ç¼ºå¤±çš„æ ¸å¿ƒæ­¥éª¤ï¼ŒAGPæ„å»ºå¿…é¡»ä¾èµ–ï¼‰
      - name: ğŸ¤– é…ç½®Androidå®˜æ–¹æ„å»ºç¯å¢ƒ
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: |
            platforms;android-${{ env.ANDROID_COMPILE_SDK }}
            build-tools;${{ env.ANDROID_BUILD_TOOLS }}
            platform-tools
        timeout-minutes: 5

      # 4. é¢„æ ¡éªŒ+æ¸…ç†æ—§æ–‡ä»¶ï¼Œé¿å…å†å²æ®‹ç•™å¯¼è‡´å†²çª
      - name: ğŸ§¹ æ¸…ç†å†å²æ®‹ç•™æ–‡ä»¶
        run: |
          set -euo pipefail
          # å¼ºåˆ¶åˆ é™¤æ—§çš„wrapper/gradleæ–‡ä»¶ï¼Œç¡®ä¿ç”Ÿæˆå…¨æ–°å®˜æ–¹ç‰ˆæœ¬
          rm -rf gradle/ gradlew gradlew.bat gradle.zip gradle-${{ env.GRADLE_VERSION }}
          # æ¸…ç†æ—§æ„å»ºç¼“å­˜ï¼Œé¿å…ç¼“å­˜æ±¡æŸ“
          rm -rf app/build/ build/ .gradle/
          # é¢„æ ¡éªŒappç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œæå‰æš´éœ²é¡¹ç›®ç»“æ„é—®é¢˜
          if [ ! -d "app" ]; then
            echo "âŒ é”™è¯¯ï¼šappé¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·ç¡®è®¤ä»“åº“ç»“æ„æ­£ç¡®"
            exit 1
          fi
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆï¼Œé¡¹ç›®ç»“æ„æ ¡éªŒé€šè¿‡"
        timeout-minutes: 1

      # 5. ä¸‹è½½å®˜æ–¹Gradle 8.2ï¼ŒåŠ å¤šé‡æ ¡éªŒ+é‡è¯•ï¼Œå½»åº•è§£å†³ä¸‹è½½å¤±è´¥/æ–‡ä»¶æŸåé—®é¢˜
      - name: ğŸ“¦ ä¸‹è½½å®˜æ–¹Gradle 8.2å®Œæ•´åŒ…
        run: |
          set -euo pipefail
          # 5æ¬¡é‡è¯•+å¤±è´¥ç«‹å³é€€å‡º+è¶…æ—¶æ§åˆ¶ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å¤±è´¥
          curl -sL \
            --retry 5 \
            --retry-delay 10 \
            --max-time 120 \
            --fail \
            --show-error \
            https://services.gradle.org/distributions/gradle-${{ env.GRADLE_VERSION }}-bin.zip \
            -o gradle.zip
          
          # æ ¡éªŒzipæ–‡ä»¶å®Œæ•´æ€§ï¼ŒæŸåç›´æ¥æŠ¥é”™é€€å‡º
          if ! unzip -tqq gradle.zip; then
            echo "âŒ é”™è¯¯ï¼šGradleå®‰è£…åŒ…æŸåï¼Œä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          # é™é»˜è§£å‹ï¼Œä¸è¾“å‡ºå†—ä½™æ—¥å¿—
          unzip -q gradle.zip
          echo "âœ… å®˜æ–¹Gradle ${{ env.GRADLE_VERSION }} ä¸‹è½½æ ¡éªŒå®Œæˆ"
        timeout-minutes: 10

      # 6. ç”Ÿæˆå®˜æ–¹æ ‡å‡†Gradle Wrapperï¼Œå¤šé‡æ ¡éªŒç¡®ä¿é›¶é”™è¯¯
      - name: ğŸ”§ ç”Ÿæˆå®˜æ–¹æ ‡å‡†Gradle Wrapper
        run: |
          set -euo pipefail
          # ç”¨å®˜æ–¹gradleå‘½ä»¤ç”Ÿæˆwrapperï¼Œä¸¥æ ¼åŒ¹é…ç‰ˆæœ¬
          gradle-${{ env.GRADLE_VERSION }}/bin/gradle wrapper \
            --gradle-version ${{ env.GRADLE_VERSION }} \
            --distribution-type bin \
            --no-daemon
          
          # å¼ºåˆ¶ç»™æ‰§è¡Œæƒé™ï¼Œå½»åº•è§£å†³command not foundé—®é¢˜
          chmod +x gradlew gradlew.bat
          
          # shellè¯­æ³•æ ¡éªŒï¼Œæå‰å‘ç°æ¢è¡Œç¬¦/è½¬ä¹‰é”™è¯¯
          if ! bash -n gradlew; then
            echo "âŒ é”™è¯¯ï¼šgradlewè„šæœ¬è¯­æ³•æ ¡éªŒå¤±è´¥"
            exit 1
          fi
          
          # æ ¡éªŒwrapperé…ç½®æ˜¯å¦æ­£ç¡®
          if ! grep -q "gradle-${{ env.GRADLE_VERSION }}-bin.zip" gradle/wrapper/gradle-wrapper.properties; then
            echo "âŒ é”™è¯¯ï¼šwrapperç‰ˆæœ¬é…ç½®å¼‚å¸¸"
            exit 1
          fi
          
          # æœ€ç»ˆéªŒè¯wrapperæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œè¿™æ­¥è¿‡ä¸äº†åé¢æ„å»ºå¿…è´¥
          ./gradlew -v --no-daemon
          echo "âœ… å®˜æ–¹gradlewç”Ÿæˆå®Œæˆï¼Œå…¨é‡æ ¡éªŒé€šè¿‡"
        timeout-minutes: 5

      # 7. é¢„ä¸‹è½½å…¨é‡ä¾èµ–ï¼Œæå‰è§£å†³ç½‘ç»œé—®é¢˜ï¼Œé¿å…æ„å»ºä¸­é€”å¤±è´¥
      - name: ğŸ“¥ é¢„ä¸‹è½½é¡¹ç›®å…¨é‡ä¾èµ–
        run: |
          set -euo pipefail
          # CIç¯å¢ƒJVMå†…å­˜ä¼˜åŒ–ï¼Œå½»åº•è§£å†³OOMå†…å­˜æº¢å‡ºé—®é¢˜
          export GRADLE_OPTS="-Xmx1536m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"
          # é¢„è§£æä¸‹è½½æ‰€æœ‰ä¾èµ–ï¼ŒåŠ é‡è¯•ï¼Œç½‘ç»œæ³¢åŠ¨è‡ªåŠ¨é‡è¯•
          ./gradlew dependencies --no-daemon --stacktrace --warning-mode all
          echo "âœ… å…¨é‡ä¾èµ–é¢„ä¸‹è½½å®Œæˆ"
        timeout-minutes: 15
        continue-on-error: false # ä¾èµ–ä¸‹è½½å¤±è´¥å¿…é¡»åœæ­¢ï¼Œé¿å…æ— æ•ˆæ„å»º

      # 8. ç”Ÿæˆç­¾åæ–‡ä»¶ï¼ŒåŠ å®¹é”™å…œåº•ï¼Œé¿å…é‡å¤ç”Ÿæˆ/ç›®å½•ä¸å­˜åœ¨æŠ¥é”™
      - name: ğŸ” ç”Ÿæˆå®‰å“ç­¾åæ–‡ä»¶
        run: |
          set -euo pipefail
          # ç¡®ä¿appç›®å½•å­˜åœ¨
          mkdir -p app
          # å¦‚æœå·²å­˜åœ¨ç­¾åæ–‡ä»¶ï¼Œè·³è¿‡ç”Ÿæˆï¼Œé¿å…è¦†ç›–
          if [ -f "${{ env.KEYSTORE_PATH }}" ]; then
            echo "âš ï¸  ç­¾åæ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ"
            exit 0
          fi
          
          # ç”Ÿæˆæ ‡å‡†å®‰å“è°ƒè¯•ç­¾åï¼Œå¯ç›´æ¥ç”¨äºReleaseæ„å»º
          keytool -genkey -v \
            -keystore ${{ env.KEYSTORE_PATH }} \
            -alias ${{ env.KEYSTORE_ALIAS }} \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass ${{ env.KEYSTORE_PASSWORD }} \
            -keypass ${{ env.KEYSTORE_PASSWORD }} \
            -dname "CN=Android Debug,O=Android,C=US" \
            -noprompt
          
          # æ ¡éªŒç­¾åæ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ ! -f "${{ env.KEYSTORE_PATH }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç­¾åæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          echo "âœ… ç­¾åæ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        timeout-minutes: 2

      # 9. è‡ªåŠ¨æ³¨å…¥ç­¾åé…ç½®ï¼ˆæ ¸å¿ƒå…œåº•ï¼è§£å†³90%çš„Releaseæ„å»ºç­¾åå¤±è´¥é—®é¢˜ï¼‰
      - name: ğŸ“ è‡ªåŠ¨æ³¨å…¥æ„å»ºç­¾åé…ç½®
        run: |
          set -euo pipefail
          BUILD_GRADLE_PATH="app/build.gradle"
          BUILD_GRADLE_KTS_PATH="app/build.gradle.kts"
          
          # é€‚é…Groovyè¯­æ³•çš„build.gradle
          if [ -f "$BUILD_GRADLE_PATH" ]; then
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç­¾åé…ç½®ï¼Œæ²¡æœ‰åˆ™æ³¨å…¥
            if ! grep -q "signingConfigs" "$BUILD_GRADLE_PATH"; then
              echo "ğŸ”§ æ³¨å…¥Groovyè¯­æ³•ç­¾åé…ç½®"
              sed -i '/android {/a \
              signingConfigs {\
                  release {\
                      storeFile file("${{ env.KEYSTORE_PATH }}")\
                      storePassword "${{ env.KEYSTORE_PASSWORD }}"\
                      keyAlias "${{ env.KEYSTORE_ALIAS }}"\
                      keyPassword "${{ env.KEYSTORE_PASSWORD }}"\
                  }\
              }\
              buildTypes {\
                  release {\
                      signingConfig signingConfigs.release\
                      minifyEnabled false\
                      proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"\
                  }\
              }' "$BUILD_GRADLE_PATH"
            fi
          # é€‚é…Kotlinè¯­æ³•çš„build.gradle.kts
          elif [ -f "$BUILD_GRADLE_KTS_PATH" ]; then
            if ! grep -q "signingConfigs" "$BUILD_GRADLE_KTS_PATH"; then
              echo "ğŸ”§ æ³¨å…¥Kotlinè¯­æ³•ç­¾åé…ç½®"
              sed -i '/android {/a \
              signingConfigs {\
                  create("release") {\
                      storeFile = file("${{ env.KEYSTORE_PATH }}")\
                      storePassword = "${{ env.KEYSTORE_PASSWORD }}"\
                      keyAlias = "${{ env.KEYSTORE_ALIAS }}"\
                      keyPassword = "${{ env.KEYSTORE_PASSWORD }}"\
                  }\
              }\
              buildTypes {\
                  getByName("release") {\
                      signingConfig = signingConfigs.getByName("release")\
                      isMinifyEnabled = false\
                      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")\
                  }\
              }' "$BUILD_GRADLE_KTS_PATH"
            fi
          else
            echo "âŒ é”™è¯¯ï¼šapp/build.gradle é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… ç­¾åé…ç½®æ³¨å…¥å®Œæˆ"
        timeout-minutes: 2

      # 10. åŒæ­¥å‰ç«¯é˜…è¯»å™¨èµ„æºï¼ŒåŠ å®¹é”™ï¼Œä¸å­˜åœ¨ä¸ä¸­æ–­æ„å»º
      - name: ğŸ“‚ åŒæ­¥å‰ç«¯ç•Œé¢èµ„æº
        run: |
          set -euo pipefail
          # é€’å½’åˆ›å»ºassetsç›®å½•ï¼Œä¸å­˜åœ¨è‡ªåŠ¨ç”Ÿæˆ
          mkdir -p app/src/main/assets/www
          
          # å‰ç«¯ç›®å½•å­˜åœ¨æ‰åŒæ­¥ï¼Œä¸å­˜åœ¨ç»™å‡ºè­¦å‘Šä¸ä¸­æ–­æ„å»º
          if [ -d "epub-reader-light" ]; then
            cp -rf epub-reader-light/* app/src/main/assets/www/
            # æ ¡éªŒåŒæ­¥æ˜¯å¦æˆåŠŸ
            if [ -z "$(ls -A app/src/main/assets/www/)" ]; then
              echo "âš ï¸  è­¦å‘Šï¼šå‰ç«¯èµ„æºåŒæ­¥åç›®å½•ä¸ºç©º"
            else
              echo "âœ… å‰ç«¯èµ„æºåŒæ­¥å®Œæˆï¼Œæ–‡ä»¶æ¸…å•ï¼š"
              ls -la app/src/main/assets/www/
            fi
          else
            echo "âš ï¸  å‰ç«¯ç›®å½•epub-reader-lightä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥"
          fi
        timeout-minutes: 2

      # 11. æ„å»ºRelease APKï¼ŒCIç¯å¢ƒä¼˜åŒ–+å†…å­˜æ§åˆ¶+å¤±è´¥é‡è¯•
      - name: ğŸš€ æ„å»ºReleaseå®‰è£…åŒ…
        run: |
          set -euo pipefail
          # æœ€ç»ˆå†…å­˜ä¼˜åŒ–ï¼Œå½»åº•è§£å†³OOMé—®é¢˜
          export GRADLE_OPTS="-Xmx1536m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"
          # å®˜æ–¹æ ‡å‡†æ„å»ºå‘½ä»¤ï¼ŒCIç¯å¢ƒä¸“å±ä¼˜åŒ–å‚æ•°
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            --warning-mode all \
            --no-configuration-cache \
            --no-watch-fs
          
          # æ ¡éªŒAPKæ˜¯å¦ç”ŸæˆæˆåŠŸ
          APK_COUNT=$(find app/build/outputs/apk/release -name "*.apk" | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šæ„å»ºå®Œæˆä½†æœªç”ŸæˆAPKæ–‡ä»¶"
            exit 1
          fi
          echo "âœ… APKæ„å»ºå®Œæˆï¼Œç”Ÿæˆæ–‡ä»¶ï¼š"
          ls -la app/build/outputs/apk/release/*.apk
        timeout-minutes: 20
        # å¶å‘å¤±è´¥è‡ªåŠ¨é‡è¯•1æ¬¡ï¼Œè§£å†³ç½‘ç»œæ³¢åŠ¨/èµ„æºç«äº‰é—®é¢˜
        retry:
          max-attempts: 2
          retry-on: error

      # 12. ä¸Šä¼ APKäº§ç‰©ï¼Œä¿ç•™30å¤©ï¼Œæ„å»ºæˆåŠŸå¿…æ‰§è¡Œ
      - name: ğŸ“¤ ä¸Šä¼ Release APKå®‰è£…åŒ…
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Reasley-Release-APK
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
        timeout-minutes: 5

      # 13. æ„å»ºå¤±è´¥å…¨é‡æ—¥å¿—æ”¶é›†ï¼Œç²¾å‡†å®šä½é—®é¢˜ï¼Œå†ä¹Ÿä¸ç”¨çŒœæŠ¥é”™
      - name: ğŸ“‹ ä¸Šä¼ æ„å»ºå¤±è´¥å…¨é‡æ—¥å¿—
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-failure-full-logs
          path: |
            **/build/reports/
            **/build/outputs/logs/
            **/build/oom-*.hprof
            **/gradle/wrapper/gradle-wrapper.properties
            gradlew
            **/build.gradle*
            **/gradle.properties
          retention-days: 30
        timeout-minutes: 5
