---
name: Reasley安卓APP构建
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: read
jobs:
  build-release-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # 1. 检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 配置JDK 17（Gradle 8.2官方要求的Java版本）
      - name: 配置JDK 17环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. 【核心修复】用Gradle 8.2官方标准流程生成wrapper，零语法错误
      - name: 生成官方Gradle Wrapper
        run: |
          # 下载并安装官方Gradle 8.2
          curl -sL https://services.gradle.org/distributions/gradle-8.2-bin.zip -o gradle.zip
          unzip -q gradle.zip
          # 用官方gradle命令生成wrapper（符合8.2版本规范）
          gradle-8.2/bin/gradle wrapper --gradle-version 8.2
          # 验证脚本语法和权限
          chmod +x gradlew
          bash -n gradlew
          echo "✅ 官方gradlew生成完成，语法验证通过"
          # 【关键】用./执行当前目录的脚本，避免command not found
          ./gradlew -v

      # 4. 生成调试签名文件（无需手动配置）
      - name: 生成签名文件
        run: |
          keytool -genkey -v \
            -keystore app/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -noprompt
          echo "✅ 签名文件生成完成"

      # 5. 同步你的前端阅读器资源到安卓项目
      - name: 同步前端界面资源
        run: |
          mkdir -p app/src/main/assets/www
          if [ -d "epub-reader-light" ]; then
            cp -r epub-reader-light/* app/src/main/assets/www/
            echo "✅ 前端资源同步完成"
            ls -la app/src/main/assets/www/
          else
            echo "⚠️  前端目录不存在，跳过同步"
          fi

      # 6. 构建Release APK（Gradle官方标准命令）
      - name: 构建Release安装包
        run: ./gradlew assembleRelease --stacktrace --no-daemon

      # 7. 上传可安装的APK产物
      - name: 上传Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Reasley-Release-APK
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      # 8. 构建失败时上传完整日志，方便排查
      - name: 上传构建失败日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs
          path: |
            **/build/reports/
            **/build/outputs/logs/
