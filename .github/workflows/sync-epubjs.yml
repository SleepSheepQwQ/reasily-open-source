name: EPUBé˜…è¯»å™¨ä¾èµ–åŒæ­¥
on:
  # åªè¦pushåˆ°mainåˆ†æ”¯å°±è§¦å‘ï¼Œä¸å†é™åˆ¶è·¯å¾„ï¼Œé¿å…ä¸æ‰§è¡Œ
  push:
    branches: [ main ]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘å…¥å£
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  sync-epub-deps:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. å¯åŠ¨æ—¥å¿—ï¼ˆç¡®è®¤è„šæœ¬çœŸçš„æ‰§è¡Œäº†ï¼‰
        run: |
          echo "====================================="
          echo "âœ… EPUBä¾èµ–åŒæ­¥workflowå·²æˆåŠŸå¯åŠ¨"
          echo "è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}"
          echo "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "====================================="

      - name: 3. ç¯å¢ƒä¸ç›®å½•å‡†å¤‡
        run: |
          set -euo pipefail
          echo "===== ç¯å¢ƒä¸å·¥å…·æ£€æŸ¥ ====="
          
          # æ£€æŸ¥å¿…è¦å·¥å…·æ˜¯å¦å­˜åœ¨
          REQUIRED_TOOLS=("wget" "sha256sum" "git" "mkdir")
          for TOOL in "${REQUIRED_TOOLS[@]}"; do
            if ! command -v "$TOOL" &> /dev/null; then
              echo "âŒ ç¼ºå°‘å¿…è¦å·¥å…·ï¼š$TOOL"
              exit 1
            fi
            echo "âœ… å·¥å…·å°±ç»ªï¼š$TOOL"
          done

          # åˆ›å»ºAPKæ‰“åŒ…å…¼å®¹çš„ç›®æ ‡ç›®å½•
          mkdir -p epub-reader-light/assets/js/
          echo "âœ… ç›®æ ‡ç›®å½•åˆ›å»ºå®Œæˆï¼šepub-reader-light/assets/js/"

          # Gitç¯å¢ƒæ ‡å‡†åŒ–
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase || true

      - name: 4. ä¸‹è½½&æ ¡éªŒepub.jsæ ¸å¿ƒä¾èµ–
        id: download
        run: |
          set -euo pipefail
          echo "===== å¼€å§‹å¤„ç†epub.jsä¾èµ– ====="

          # å›ºå®šä¾èµ–é…ç½®ï¼Œå½»åº•æœç»å˜é‡ç©ºå€¼é—®é¢˜
          DEP_NAME="epub.js"
          DEP_VERSION="0.3.93"
          DOWNLOAD_URL="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"
          TARGET_PATH="epub-reader-light/assets/js/epub.min.js"
          EXPECTED_SHA="06eae15745107b4aa508c95538275251f69bfb9f1175621fc458d9f42ed082d4"

          # ä¸´æ—¶æ–‡ä»¶è·¯å¾„
          TMP_FILE="./epub.min.js.tmp"

          # ä¸‹è½½æ–‡ä»¶
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ $DEP_NAME v$DEP_VERSION"
          wget --tries=3 --timeout=10 -O "$TMP_FILE" "$DOWNLOAD_URL"

          # æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
          FILE_SIZE=$(stat -c%s "$TMP_FILE")
          echo "ğŸ“¦ ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š$FILE_SIZE å­—èŠ‚"
          if [ "$FILE_SIZE" -lt 1024 ]; then
            echo "âŒ æ–‡ä»¶å¼‚å¸¸ï¼Œå¤§å°ä¸è¶³1KBï¼Œä¸‹è½½å¤±è´¥"
            exit 1
          fi

          # SHA256å“ˆå¸Œæ ¡éªŒ
          ACTUAL_SHA=$(sha256sum "$TMP_FILE" | awk '{print $1}')
          echo "ğŸ” æœŸæœ›å“ˆå¸Œï¼š$EXPECTED_SHA"
          echo "ğŸ” å®é™…å“ˆå¸Œï¼š$ACTUAL_SHA"

          if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
            echo "âŒ å“ˆå¸Œæ ¡éªŒå¤±è´¥ï¼Œæ–‡ä»¶è¢«ç¯¡æ”¹æˆ–ä¸‹è½½ä¸å®Œæ•´"
            exit 1
          fi
          echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡ï¼"

          # åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
          HAS_CHANGE=false
          if [ -f "$TARGET_PATH" ]; then
            CURRENT_SHA=$(sha256sum "$TARGET_PATH" | awk '{print $1}')
            if [ "$CURRENT_SHA" != "$ACTUAL_SHA" ]; then
              HAS_CHANGE=true
            fi
          else
            HAS_CHANGE=true
          fi

          # ç§»åŠ¨æ–‡ä»¶åˆ°æœ€ç»ˆç›®æ ‡è·¯å¾„
          mv -f "$TMP_FILE" "$TARGET_PATH"
          echo "âœ… ä¾èµ–å·²å†™å…¥ç›®æ ‡è·¯å¾„ï¼š$TARGET_PATH"

          # è¾“å‡ºç»“æœç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "has_change=$HAS_CHANGE" >> "$GITHUB_OUTPUT"
          echo "target_path=$TARGET_PATH" >> "$GITHUB_OUTPUT"

      - name: 5. æäº¤å˜æ›´åˆ°mainåˆ†æ”¯
        if: steps.download.outputs.has_change == 'true'
        run: |
          set -euo pipefail
          echo "===== æäº¤ä¾èµ–å˜æ›´ ====="
          git add ${{ steps.download.outputs.target_path }}
          git commit -m "chore: è‡ªåŠ¨åŒæ­¥epub.js v0.3.93ä¾èµ–"
          git push origin main
          echo "âœ… å˜æ›´å·²æˆåŠŸæäº¤åˆ°mainåˆ†æ”¯ï¼"

      - name: 6. æœ€ç»ˆæ‰§è¡Œç»“æœ
        run: |
          echo "====================================="
          echo "ğŸ‰ workflowæ‰§è¡Œå®Œæˆï¼"
          if [ "${{ steps.download.outputs.has_change }}" == "true" ]; then
            echo "âœ… epub.jsä¾èµ–å·²æˆåŠŸåŒæ­¥åˆ°ä½ çš„ä»“åº“"
            echo "ğŸ“ æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼š${{ steps.download.outputs.target_path }}"
          else
            echo "â„¹ï¸  ä¾èµ–å·²å­˜åœ¨ä¸”æ— å˜æ›´ï¼Œæ— éœ€æ›´æ–°"
          fi
          echo "====================================="

      - name: 7. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f ./*.tmp
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
