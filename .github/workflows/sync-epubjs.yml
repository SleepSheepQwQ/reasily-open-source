name: EPUBé˜…è¯»å™¨ä¾èµ–åŒæ­¥
on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/sync-epubjs.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "é¢„æ ¡éªŒæ¨¡å¼ï¼šä»…æ£€æŸ¥ä¸ä¿®æ”¹ä»“åº“"
        type: boolean
        default: true
        required: false
      create_pr:
        description: "æ­£å¼æ¨¡å¼ï¼šå˜æ›´é€šè¿‡PRäººå·¥å®¡æ ¸åˆå¹¶"
        type: boolean
        default: true
        required: false
      force_update:
        description: "å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶"
        type: boolean
        default: false
        required: false

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  sync-epub-deps:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ‹‰å–é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: "${{ secrets.GITHUB_TOKEN }}"

      - name: ç¯å¢ƒä¸ç›®å½•é¢„æ ¡éªŒï¼ˆé€‚é…APKæ„å»ºç›®å½•ç»“æ„ï¼‰
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          echo "===== ç¯å¢ƒé¢„æ ¡éªŒå¼€å§‹ ====="
          
          REQUIRED_TOOLS=("wget" "sha256sum" "git" "mkdir" "rm" "mv")
          for TOOL in "${REQUIRED_TOOLS[@]}"; do
            if ! command -v "$TOOL" &> /dev/null; then
              echo "âŒ ç¼ºå°‘å¿…è¦å·¥å…·ï¼š$TOOL"
              exit 1
            fi
            echo "âœ… å·¥å…·æ£€æŸ¥é€šè¿‡ï¼š$TOOL"
          done

          # å›ºå®šAPKæ„å»ºå…¼å®¹çš„ç›®å½•ç»“æ„ï¼ˆWebViewæ‰“åŒ…æ ‡å‡†ç›®å½•ï¼‰
          CORE_DIRS=(
            "epub-reader-light/assets/css"
            "epub-reader-light/assets/js"
            "epub-reader-light/assets/fonts"
            "epub-reader-light/assets/epubs"
          )
          for DIR in "${CORE_DIRS[@]}"; do
            if [ ! -d "$DIR" ]; then
              echo "âš ï¸  è‡ªåŠ¨åˆ›å»ºç›®å½•ï¼š$DIR"
              mkdir -p "$DIR"
            fi
            echo "âœ… ç›®å½•æ£€æŸ¥é€šè¿‡ï¼š$DIR"
          done

          # Gitç¯å¢ƒæ ‡å‡†åŒ–
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase

          echo "===== ç¯å¢ƒé¢„æ ¡éªŒå…¨éƒ¨é€šè¿‡ ====="

      - name: åŠ è½½ä¾èµ–é…ç½®ï¼ˆæ ¸å¿ƒå¼€æºå·¥å…·ï¼Œå“ˆå¸Œå·²ä¿®æ­£ï¼‰
        id: load-config
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          # ä¾èµ–é…ç½®åŒºï¼šåç»­æ–°å¢å¼€æºå·¥å…·ç›´æ¥åœ¨è¿™é‡ŒåŠ è¡Œ
          # æ ¼å¼ï¼šå·¥å…·å|ç‰ˆæœ¬|ä¸‹è½½ç›´é“¾|ç›®æ ‡è·¯å¾„|SHA256å“ˆå¸Œå€¼
          cat > .deps_list << 'DEPS_EOF'
          epub.js|0.3.93|https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js|epub-reader-light/assets/js/epub.min.js|06eae15745107b4aa508c95538275251f69bfb9f1175621fc458d9f42ed082d4
          DEPS_EOF

          grep -v '^#' .deps_list | grep -v '^$' > .valid_deps
          echo "dep_count=$(wc -l < .valid_deps)" >> "$GITHUB_OUTPUT"

      - name: ä¸‹è½½&æ ¡éªŒå¼€æºä¾èµ–
        id: download-deps
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          echo "===== ä¾èµ–æ‹‰å–å¼€å§‹ ====="
          TMP_DIR="./.tmp_deps"
          mkdir -p "$TMP_DIR"
          
          CHANGE_LOG="./.change_log.md"
          echo "# å¼€æºä¾èµ–åŒæ­¥å˜æ›´æ—¥å¿—" > "$CHANGE_LOG"
          echo "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> "$CHANGE_LOG"
          echo "è§¦å‘äººï¼š${{ github.actor }}" >> "$CHANGE_LOG"
          echo "" >> "$CHANGE_LOG"
          echo "| å·¥å…·å | ç‰ˆæœ¬ | å˜æ›´ç±»å‹ | ç›®æ ‡è·¯å¾„ | çŠ¶æ€ |" >> "$CHANGE_LOG"
          echo "| ---- | ---- | ---- | ---- | ---- |" >> "$CHANGE_LOG"

          HAS_CHANGE=false
          FORCE_UPDATE="${{ inputs.force_update || 'false' }}"

          while IFS='|' read -r NAME VERSION URL TARGET_PATH EXPECTED_SHA; do
            NAME=$(echo "$NAME" | xargs)
            VERSION=$(echo "$VERSION" | xargs)
            URL=$(echo "$URL" | xargs)
            TARGET_PATH=$(echo "$TARGET_PATH" | xargs)
            EXPECTED_SHA=$(echo "$EXPECTED_SHA" | xargs)

            echo ""
            echo "===== å¤„ç†ä¾èµ–ï¼š$NAME v$VERSION ====="

            TARGET_DIR=$(dirname "$TARGET_PATH")
            mkdir -p "$TARGET_DIR"

            CURRENT_SHA=""
            if [ -f "$TARGET_PATH" ]; then
              CURRENT_SHA=$(sha256sum "$TARGET_PATH" | awk '{print $1}')
              if [ "$CURRENT_SHA" == "$EXPECTED_SHA" ] && [ "$FORCE_UPDATE" != "true" ]; then
                echo "âœ… æ–‡ä»¶å·²å­˜åœ¨ä¸”å“ˆå¸ŒåŒ¹é…ï¼Œè·³è¿‡å¤„ç†"
                echo "| $NAME | $VERSION | æ— å˜æ›´ | $TARGET_PATH | é€šè¿‡ |" >> "$CHANGE_LOG"
                continue
              fi
            fi

            TMP_FILE="$TMP_DIR/$(basename "$TARGET_PATH")"
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ï¼š$URL"
            if ! wget --tries=3 --wait=5 --timeout=10 -O "$TMP_FILE" "$URL"; then
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$NAME v$VERSION"
              exit 1
            fi

            FILE_SIZE=$(stat -c%s "$TMP_FILE")
            if [ "$FILE_SIZE" -lt 1024 ]; then
              echo "âŒ æ–‡ä»¶å¼‚å¸¸ï¼Œå¤§å°ä¸è¶³1KB"
              exit 1
            fi

            ACTUAL_SHA=$(sha256sum "$TMP_FILE" | awk '{print $1}')
            if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
              echo "âŒ å“ˆå¸Œæ ¡éªŒå¤±è´¥"
              echo "æœŸæœ›å“ˆå¸Œï¼š$EXPECTED_SHA"
              echo "å®é™…å“ˆå¸Œï¼š$ACTUAL_SHA"
              exit 1
            fi
            echo "âœ… å“ˆå¸Œæ ¡éªŒé€šè¿‡"

            if [ "${{ inputs.dry_run }}" != "true" ]; then
              mv -f "$TMP_FILE" "$TARGET_PATH"
              echo "âœ… ä¾èµ–å†™å…¥å®Œæˆï¼š$TARGET_PATH"
            else
              echo "âœ… é¢„æ ¡éªŒé€šè¿‡ï¼Œdry runæ¨¡å¼ä¸ä¿®æ”¹æ–‡ä»¶"
            fi

            CHANGE_TYPE=$([ -z "$CURRENT_SHA" ] && echo "æ–°å¢" || echo "æ›´æ–°")
            echo "| $NAME | $VERSION | $CHANGE_TYPE | $TARGET_PATH | é€šè¿‡ |" >> "$CHANGE_LOG"
            HAS_CHANGE=true

          done < .valid_deps

          echo "has_change=$HAS_CHANGE" >> "$GITHUB_OUTPUT"
          echo "change_log_path=$CHANGE_LOG" >> "$GITHUB_OUTPUT"
          echo "tmp_dir=$TMP_DIR" >> "$GITHUB_OUTPUT"

      - name: é¢„æ ¡éªŒæ¨¡å¼ç»“æœè¾“å‡º
        if: inputs.dry_run == true
        run: |
          set -euo pipefail
          echo "===== é¢„æ ¡éªŒæ‰§è¡Œå®Œæˆ ====="
          echo "âœ… æ‰€æœ‰ä¾èµ–æ ¡éªŒé€šè¿‡ï¼Œæ— æ‰§è¡Œé”™è¯¯"
          echo "â„¹ï¸  æœ¬æ¬¡ä¸ºé¢„æ ¡éªŒæ¨¡å¼ï¼Œæœªå¯¹ä»“åº“è¿›è¡Œä»»ä½•ä¿®æ”¹"
          echo ""
          echo "===== å˜æ›´é¢„è§ˆ ====="
          cat "${{ steps.download-deps.outputs.change_log_path }}"

      - name: åˆ›å»ºå˜æ›´åˆ†æ”¯
        if: inputs.dry_run == false && steps.download-deps.outputs.has_change == 'true'
        id: create-branch
        run: |
          set -euo pipefail
          BRANCH_NAME="auto-update-deps/$(date '+%Y%m%d-%H%M%S')"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          
          git checkout -b "$BRANCH_NAME"
          git add epub-reader-light/assets/
          git commit -m "chore: è‡ªåŠ¨åŒæ­¥å¼€æºä¾èµ– [$(date '+%Y-%m-%d %H:%M')]"

      - name: åˆ›å»ºPRä¾›äººå·¥å®¡æ ¸
        if: inputs.dry_run == false && inputs.create_pr == true && steps.download-deps.outputs.has_change == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          branch: "${{ steps.create-branch.outputs.branch_name }}"
          base: main
          title: "chore: è‡ªåŠ¨åŒæ­¥å¼€æºä¾èµ– [$(date '+%Y-%m-%d')]"
          body-path: "${{ steps.download-deps.outputs.change_log_path }}"
          labels: |
            dependencies
            automated
          delete-branch: true

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf .tmp_* .deps_list .valid_deps .change_log.md
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: æœ€ç»ˆæ‰§è¡Œç»“æœ
        run: |
          echo "===== å·¥ä½œæµæ‰§è¡Œå®Œæˆ ====="
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âœ… é¢„æ ¡éªŒæ¨¡å¼æ‰§è¡ŒæˆåŠŸ"
          else
            if [ "${{ steps.download-deps.outputs.has_change }}" == "true" ]; then
              echo "âœ… æ­£å¼æ¨¡å¼æ‰§è¡ŒæˆåŠŸ"
              if [ "${{ inputs.create_pr }}" == "true" ]; then
                echo "âœ… PRå·²åˆ›å»ºï¼Œè¯·å®¡æ ¸åˆå¹¶"
              fi
            else
              echo "âœ… æ‰§è¡ŒæˆåŠŸï¼Œæ— ä¾èµ–å˜æ›´"
            fi
          fi
